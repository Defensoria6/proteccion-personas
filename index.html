<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Proteccion NNyA</title>
  <style>
    :root{
      --brand:#004085;--bg: #a3c8ff;--card:#fff;--line:#e3e6ea;--muted:#6b7280;
      --accent:#0d6efd;--accent-dark:#0b5ed7;--ok:#198754;--warn:#ea580c;--danger:#dc3545;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:'Segoe UI',system-ui,Arial,sans-serif;background:var(--bg);margin:0;padding:20px;color:#111}
    .container{max-width:1300px;margin:0 auto;background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden}
    /* --- Navegación como tarjetas --- */
    .nav-wrap{background:white;border-bottom:1px solid var(--line);padding:16px}
    .nav-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .nav-card{display:flex;flex-direction:column;gap:10px;background:#fff;border:1px solid var(--line);border-radius:12px;padding:14px;transition:transform .06s ease, box-shadow .2s ease;cursor:pointer}
    .nav-card:hover{box-shadow:0 6px 20px rgba(0,0,0,.06);transform:translateY(-1px)}
    .nav-card h4{margin:0;color:var(--brand)}
    .nav-card p{margin:0;color:var(--muted);font-size:.9rem;line-height:1.35}
    .nav-actions{display:flex;gap:8px;flex-wrap:wrap}
    .nav-btn{padding:10px 12px;border:none;border-radius:10px;background:var(--accent);color:#fff;font-weight:700}
    .nav-btn:active{transform:translateY(1px)}
    .tab-content{display:none;padding:22px}.tab-content.active{display:block}
    /* --- Layouts y tablas --- */
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .form-row.full{grid-template-columns:1fr}
    .subgrid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    label{display:block;margin:6px 0;font-weight:600}
    input,select,textarea{width:100%;padding:10px;border:1px solid #cfd6de;border-radius:8px;background:#fff}
    textarea{min-height:90px;resize:vertical}
    .small{font-size:.85rem;color:var(--muted)}
    .fieldset{border:1px dashed var(--line);border-radius:12px;padding:14px;margin:12px 0;background:#fff}
    .fieldset legend{padding:0 6px;color:var(--brand);font-weight:700}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
    .chip{padding:4px 10px;border:1px solid var(--line);border-radius:999px;font-size:.85rem;background:#fff}
    .btn{padding:9px 14px;border:none;border-radius:10px;cursor:pointer;font-weight:700}
    .btn-primary{background:var(--brand);color:#fff}.btn-secondary{background:#6c757d;color:#fff}
    .btn-danger{background:var(--danger);color:#fff}.btn-ghost{background:#fff;border:1px solid var(--line);color:#111}
    .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .cases-table{width:100%;border-collapse:collapse;margin-top:14px}
    .cases-table th,.cases-table td{padding:10px;border-bottom:1px solid var(--line)}.cases-table th{background:var(--brand);color:#fff}
    .actions{display:flex;gap:6px;flex-wrap:wrap}
    .status-abierto{color:var(--ok);font-weight:bold}.status-en{color:#0ea5e9;font-weight:bold}.status-cerrado{color:var(--danger);font-weight:bold}
    .row-highlight{animation:hilite 2.2s ease-in-out 1; background:#fff9c4 !important}
    @keyframes hilite{0%{background:#fff9c4} 100%{background:transparent}}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .section{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff}
    /* --- Sidebar Seguimiento --- */
    #sidebarSeguimiento{position:fixed;top:0;right:-460px;width:460px;height:100%;background:#fff;box-shadow:-2px 0 14px rgba(0,0,0,.15);transition:right .28s;z-index:1200;display:flex;flex-direction:column}
    #sidebarSeguimiento.active{right:0}
    #sidebarSeguimiento .s-header{background:var(--brand);color:#fff;padding:14px;display:flex;justify-content:space-between;align-items:center}
    #sidebarSeguimiento .s-body{padding:16px;overflow:auto;flex:1}
    .timeline-item{border-left:3px solid var(--brand);margin-left:10px;padding-left:12px;margin-bottom:12px;position:relative}
    .timeline-item .date{font-size:.82rem;color:var(--muted)}.timeline-item .delete-btn{position:absolute;right:0;top:0;background:none;border:none;color:var(--danger);cursor:pointer}
    .seguimiento-form{border-top:1px solid var(--line);padding:14px;background:#fafbfc}
    /* --- Modales --- */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1300;align-items:center;justify-content:center;padding:20px}
    .modal.open{display:flex}.modal-card{width:min(980px,96vw);max-height:88vh;background:#fff;border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
    .modal-head{background:var(--brand);color:#fff;padding:14px;display:flex;justify-content:space-between;align-items:center}
    .modal-body{padding:18px;overflow:auto}
    .print-actions{padding:12px;display:flex;justify-content:flex-end;gap:8px;border-top:1px solid var(--line)}
    .filters{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    .filters input,.filters select{padding:8px;border-radius:8px;border:1px solid var(--line)}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:.8rem;border:1px solid var(--line);background:#fff}
    .badge-ok{color:var(--ok);border-color:var(--ok)} .badge-warn{color:var(--warn);border-color:var(--warn)} .badge-danger{color:var(--danger);border-color:var(--danger)}
    /* --- Nuevo Estilo de Registro --- */
    .reg-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-top:16px}
    .reg-card{display:flex;flex-direction:column;gap:10px;background:#fff;border:1px solid var(--line);border-radius:12px;padding:22px;transition:transform .06s ease, box-shadow .2s ease;cursor:pointer}
    .reg-card:hover{box-shadow:0 6px 20px rgba(0,0,0,.06);transform:translateY(-1px)}
    .reg-card h4{margin:0;color:var(--brand)}
    .reg-card p{margin:0;color:var(--muted);font-size:.9rem;line-height:1.35}
    .reg-card .badge{position:absolute;top:10px;right:10px}
    /* --- Responsividad extra --- */
    @media (max-width: 1140px){ .nav-grid{grid-template-columns:1fr 1fr} }
    @media (max-width: 760px){
      body { padding: 8px }
      .container { border-radius: 10px }
      .nav-grid{grid-template-columns:1fr}
      .form-row, .subgrid-3 { grid-template-columns: 1fr }
      .grid-2 { grid-template-columns: 1fr }
      .nav-card{padding:12px}
      h1,h2,h3,h4{font-size:1rem}
      .btn{padding:8px 10px;font-size:.95rem}
      .cases-table{display:block;overflow-x:auto}
      #sidebarSeguimiento{width:100%}
      .modal-card{width:100%;height:95vh;border-radius:0}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="nav-wrap">
      <div class="nav-grid">
        <div class="nav-card" onclick="showTab('inicio',event)">
          <h4>Inicio</h4>
          <p>Resumen en tiempo real: totales de casos, estados y lista rápida de trámites.</p>
          <div class="nav-actions">
            <button class="nav-btn">Abrir Panel</button>
          </div>
        </div>
        <div class="nav-card" onclick="showTab('registro',event)">
          <h4>Nuevo Caso</h4>
          <p>Registre un caso según la Ley II N° 16 y II N°36</p>
          <div class="nav-actions">
            <button class="nav-btn">Crear Caso</button>
          </div>
        </div>
        <div class="nav-card" onclick="showTab('casos',event)">
          <h4>Casos Registrados</h4>
          <p>Listado filtrable, vista detallada, edición, seguimiento y eliminación.</p>
          <div class="nav-actions">
            <button class="nav-btn">Ver Listado</button>
          </div>
        </div>
      </div>
    </div>

    <div id="inicio" class="tab-content active">
      <h2>Protección NNyA</h2>
      <p class="small" style="background:#fff3cd;padding:10px;border-radius:10px">
      </p>
      <div class="grid-2">
        <div class="section" id="inicioLeft">
          <h4>Totales</h4>
          <p>Total: <strong id="totalCasos">0</strong></p>
          <p class="status-abierto">Abiertos: <strong id="casosAbiertos">0</strong></p>
          <p class="status-en">En Proceso: <strong id="casosProceso">0</strong></p>
          <p class="status-cerrado">Cerrados: <strong id="casosCerrados">0</strong></p>
          <div style="margin-top:8px" class="inline">
            <button class="btn btn-primary" onclick="imprimirSeccion('inicio')">Imprimir Panel</button>
          </div>
        </div>
        <div class="section" id="inicioRight">
          <h4>Casos en trámite</h4>
          <ul id="listaTramite" style="max-height:300px;overflow:auto;margin:0;padding-left:16px"></ul>
        </div>
      </div>
    </div>

    <div id="registro" class="tab-content">
      <h2 id="formTitle">Nuevo Caso</h2>
      <p class="small">Seleccione un módulo para ingresar la información del caso.</p>
      <div class="reg-grid">
        <div class="reg-card" onclick="openModal('modulo1')">
          <h4>Datos del NNA</h4>
          <p>Información del niño, niña o adolescente según la Ley II - N.º 36.</p>
          <span class="badge" id="badge-modulo1" style="display:none">✅ Completo</span>
        </div>
        <div class="reg-card" onclick="openModal('modulo2')">
          <h4>Medida y Acogimiento</h4>
          <p>Detalles sobre la medida de protección y la familia de acogimiento.</p>
          <span class="badge" id="badge-modulo2" style="display:none">✅ Completo</span>
        </div>
        <div class="reg-card" onclick="openModal('modulo3')">
          <h4>Información Adicional</h4>
          <p>Registro de datos culturales y personales según la Ley II - N.º 16.</p>
          <span class="badge" id="badge-modulo3" style="display:none">✅ Completo</span>
        </div>
        <div class="reg-card" onclick="openModal('modulo4')">
          <h4>Información Familiar</h4>
          <p>Datos de la familia de origen y tipo de vínculo.</p>
          <span class="badge" id="badge-modulo4" style="display:none">✅ Completo</span>
        </div>
        <div class="reg-card" onclick="openModal('modulo5')">
          <h4>Medidas y Seguimiento</h4>
          <p>Medidas de protección aplicadas al caso.</p>
          <span class="badge" id="badge-modulo5" style="display:none">✅ Completo</span>
        </div>
        <div class="reg-card" onclick="openModal('modulo6')">
          <h4>Garantías Procesales</h4>
          <p>Detalles sobre asistencia letrada y actos infractores.</p>
          <span class="badge" id="badge-modulo6" style="display:none">✅ Completo</span>
        </div>
        <div class="reg-card" onclick="openModal('modulo7')">
          <h4>Requisitos RUFAAFA</h4>
          <p>Cumplimiento de los requisitos para la familia de acogimiento.</p>
          <span class="badge" id="badge-modulo7" style="display:none">✅ Completo</span>
        </div>
        <div class="reg-card" onclick="openModal('modulo8')">
          <h4>Inhabilidades</h4>
          <p>Condiciones que inhabilitan para ser familia de acogimiento.</p>
          <span class="badge" id="badge-modulo8" style="display:none">✅ Completo</span>
        </div>
        <div class="reg-card" onclick="openModal('modulo9')">
          <h4>Expediente y Seguimiento</h4>
          <p>Datos del expediente, estado y seguimiento inicial.</p>
          <span class="badge" id="badge-modulo9" style="display:none">✅ Completo</span>
        </div>
      </div>
      
      <div class="form-row full" style="margin-top:20px;">
        <div class="inline">
          <button type="button" class="btn btn-primary" onclick="guardarCaso()">Guardar Caso Completo</button>
          <button type="button" class="btn btn-secondary" onclick="resetForm()">Cancelar</button>
        </div>
      </div>
      <p id="validacionMsg" class="small"></p>
    </div>

    <div style="display:none;">
      <form id="modulo1Form">
        <legend>Datos del NNA (Ley II - N.º 36)</legend>
        <div class="form-row">
          <div><label>Nombre *</label><input id="nombreNNA" required></div>
          <div><label>DNI</label><input id="dniNNA"></div>
        </div>
        <div class="form-row">
          <div><label>Fecha nac.</label><input type="date" id="fechaNacimientoNNA"></div>
          <div><label>Género</label>
            <select id="generoNNA"><option></option><option>Masculino</option><option>Femenino</option><option>Otro</option></select>
          </div>
        </div>
        <div class="form-row">
          <div><label>Centro de vida (localidad/prov.)</label><input id="centroVida"></div>
          <div><label>Vínculos fraternos preservados</label>
            <select id="vinculosFraternos"><option value=""></option><option>Sí</option><option>No</option></select>
          </div>
        </div>
        <div class="form-row full"><label>Situación</label><textarea id="situacionVulneracion"></textarea></div>
        <div class="small inline">
          <span id="edadNNAInfo" class="badge">Edad NNA: —</span>
        </div>
      </form>
      <form id="modulo2Form">
        <legend>Medida y Acogimiento (Ley II - N.º 36)</legend>
        <div class="form-row">
          <div><label>Tipo de medida excepcional</label>
            <select id="tipoMedida"><option value=""></option><option>Administrativa con intervención judicial</option><option>Judicial</option></select>
          </div>
          <div><label>Autoridad interviniente</label><input id="autoridadInterviniente" placeholder="Órgano/juzgado/área"></div>
        </div>
        <div class="form-row">
          <div><label>Fecha de la medida</label><input type="date" id="fechaMedida"></div>
          <div><label>Fecha de ingreso al SAF</label><input type="date" id="fechaIngresoSAF"></div>
        </div>
        <div class="form-row">
          <div><label>Tipo de familia de acogimiento</label>
            <select id="tipoFamilia"><option value=""></option><option>Alternativa</option><option>Inmediata (≤ 10 días)</option></select>
          </div>
          <div><label>RUFAAFA (N° registro)</label><input id="rufAAFA"></div>
        </div>
        <div class="form-row">
          <div><label>Referente de familia de acogimiento</label><input id="faNombre" placeholder="Nombre y apellido"></div>
          <div><label>DNI referente</label><input id="faDni" placeholder="Documento"></div>
        </div>
        <div class="form-row">
          <div><label>Fecha nac. referente</label><input type="date" id="faFechaNac"></div>
          <div><label>Contacto (tel/correo)</label><input id="faContacto"></div>
        </div>
        <div class="form-row">
          <div><label>Domicilio familia de acogimiento</label><input id="faDomicilio"></div>
          <div><label>Años de residencia en Misiones</label><input type="number" min="0" step="1" id="faResidenciaAnos" placeholder="Ej: 3"></div>
        </div>
        <div class="small inline">
          <span id="edadFAInfo" class="badge">Edad referente: —</span>
          <span id="difEdadInfo" class="badge">Diferencia con NNA: —</span>
          <span id="residenciaInfo" class="badge">Residencia: —</span>
        </div>
        <div class="form-row full">
          <label>Etapa del proceso (Art. 14)</label>
          <div class="chips">
            <label class="chip"><input type="checkbox" id="etapaConvocatoria"> Convocatoria</label>
            <label class="chip"><input type="checkbox" id="etapaEvaluacion"> Evaluación y selección</label>
            <label class="chip"><input type="checkbox" id="etapaCapacitacion"> Capacitación</label>
            <label class="chip"><input type="checkbox" id="etapaInscripcion"> Inscripción RUFAAFA</label>
            <label class="chip"><input type="checkbox" id="etapaPlan"> Plan de intervención</label>
          </div>
        </div>
        <div class="form-row full">
          <label>Plan de intervención</label>
          <textarea id="planIntervencion" placeholder="Objetivos, acciones, roles (Art.14.5)"></textarea>
        </div>
        <div class="form-row">
          <div><label>Egreso (si aplica)</label>
            <select id="causalEgreso">
              <option value=""></option>
              <option>Revinculación con familia de origen</option>
              <option>Vinculación con familia extensa</option>
              <option>Adoptabilidad y guarda con fines de adopción</option>
              <option>Mayoría de edad</option>
            </select>
          </div>
          <div><label>Fecha de egreso</label><input type="date" id="fechaEgreso"></div>
        </div>
        <div class="form-row full">
          <label>Observaciones sobre derecho a ser oído / identidad / integridad</label>
          <textarea id="obsDerechos" placeholder="Registro de escucha activa, identidad y resguardo (Art. 4)"></textarea>
        </div>
      </form>
      <form id="modulo3Form">
        <legend>Información Adicional (Ley II - N.º 16)</legend>
        <div class="form-row">
          <div><label>Nombre Completo del NNA *</label><input id="nombreCompletoNNA" required></div>
          <div><label>Nacionalidad</label><input id="nacionalidadNNA"></div>
        </div>
        <div class="form-row">
          <div><label>Identidad cultural / Idioma de origen</label><input id="identidadCulturalNNA"></div>
          <div><label>Opinión del NNA</label><textarea id="opinionNNA" placeholder="Registrar la opinión y deseos del menor sobre el caso."></textarea></div>
        </div>
      </form>
      <form id="modulo4Form">
        <legend>Información Familiar (Ley II - N.º 16)</legend>
        <div class="form-row">
          <div><label>Nombre de la madre</label><input id="nombreMadre"></div>
          <div><label>Nombre del padre</label><input id="nombrePadre"></div>
        </div>
        <div class="form-row">
          <div><label>Estado del Vínculo Familiar</label>
            <select id="vinculoFamiliar">
              <option value=""></option>
              <option>Grupo Familiar de Origen</option>
              <option>Familia Ampliada</option>
              <option>Hogar Alternativo</option>
            </select>
          </div>
          <div><label>Observaciones familiares</label><textarea id="obsFamilia" placeholder="Detalles de la convivencia, etc."></textarea></div>
        </div>
      </form>
      <form id="modulo5Form">
        <legend>Medidas de Protección y Seguimiento (Ley II - N.º 16)</legend>
        <div class="form-row full">
          <label>Medidas de Protección Aplicadas</label>
          <div class="chips">
            <label class="chip"><input type="checkbox" id="medidaGuiaAsistencia"> Guía y asistencia a la familia</label>
            <label class="chip"><input type="checkbox" id="medidaAsistenciaSalud"> Asistencia a tratamientos médicos/psicológicos</label>
            <label class="chip"><input type="checkbox" id="medidaInscripcionEscolar"> Apoyo para la inscripción escolar</label>
            <label class="chip"><input type="checkbox" id="medidaExclusionAgresor"> Exclusión del agresor de la vivienda</label>
            <label class="chip"><input type="checkbox" id="medidaOtros"> Otras medidas (especificar)</label>
          </div>
        </div>
        <div class="form-row full">
          <label>Observaciones y Plazo de la Medida</label>
          <textarea id="obsMedida" placeholder="Documentar la efectividad de la medida, su duración y las causas que la motivaron."></textarea>
        </div>
      </form>
      <form id="modulo6Form">
        <legend>Garantías Procesales (Ley II - N.º 16)</legend>
        <div class="form-row">
          <div><label>Asistencia Letrada (nombre del abogado)</label><input id="asistenciaLetrada"></div>
          <div><label>Acto Infractor Atribuido</label><input id="actoInfractor"></div>
        </div>
        <div class="form-row full">
          <label>Información a la familia</label>
          <textarea id="infoFamilia" placeholder="Detalles sobre cómo y cuándo se informó a la familia sobre la situación."></textarea>
        </div>
      </form>
      <form id="modulo7Form">
        <legend>Requisitos RUFAAFA (Ley II - N.º 36)</legend>
        <div class="subgrid-3">
          <label class="chip"><input type="checkbox" id="reqDomicilio"> Domicilio en Misiones (≥ 2 años)</label>
          <label class="chip"><input type="checkbox" id="reqEdad"> Mayor de 25 años</label>
          <label class="chip"><input type="checkbox" id="reqDiferenciaEdad"> Diferencia ≥ 15 años con el NNA</label>
          <label class="chip"><input type="checkbox" id="reqPenales"> Cert. antecedentes penales</label>
          <label class="chip"><input type="checkbox" id="reqAlimentaria"> Libre deuda alimentaria</label>
          <label class="chip"><input type="checkbox" id="reqPsicofisico"> Aptitud psicofísica (sector público)</label>
          <label class="chip"><input type="checkbox" id="reqIngresos"> Constancia/ DDJJ de ingresos</label>
          <label class="chip"><input type="checkbox" id="reqVivienda"> Acredita vivienda (propia/locación)</label>
          <label class="chip"><input type="checkbox" id="reqCapacitacion"> Capacitaciones realizadas</label>
          <label class="chip"><input type="checkbox" id="reqAcuerdo"> Acuerdo de aceptación firmado</label>
        </div>
      </form>
      <form id="modulo8Form">
        <legend>Inhabilidades (Ley II - N.º 36)</legend>
        <div class="subgrid-3">
          <label class="chip"><input type="checkbox" id="inhDelitos"> Sin condena por delitos dolosos</label>
          <label class="chip"><input type="checkbox" id="inhMedidas"> Sin medidas cautelares vigentes (L. XIV-6 / IV-68)</label>
          <label class="chip"><input type="checkbox" id="inhRespParental"> Sin privación/suspensión de resp. parental</label>
          <label class="chip"><input type="checkbox" id="inhTutela"> Sin remoción de tutela por mal desempeño</label>
        </div>
      </form>
      <form id="modulo9Form">
        <legend>Expediente y Seguimiento</legend>
        <div class="form-row">
          <div><label>Expediente de referencia</label>
            <select id="expedienteReferencia"><option value="">-- Seleccione --</option></select>
            <small id="expedienteInfo" class="small"></small>
          </div>
          <div><label>Estado</label>
            <select id="estadoCaso"><option>Abierto</option><option>En Proceso</option><option>Cerrado</option></select>
          </div>
        </div>
        <div class="form-row full"><label>Seguimiento inicial</label><textarea id="seguimientoInicial" placeholder="Anote el primer seguimiento o acción..."></textarea></div>
        <div class="form-row">
          <div><label>Lugar de institucionalización</label><textarea id="lugarInstitucionalizacion" placeholder="Si corresponde"></textarea></div>
          <div><label>Contacto institucionalizacion</label><textarea id="contactoInstitucionalizacion" placeholder="Si corresponde"></textarea></div>
        </div>
      </form>
    </div>

    <div id="casos" class="tab-content">
      <div style="display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap">
        <h2>Casos Registrados</h2>
        <div class="inline">
          <button class="btn btn-primary" onclick="imprimirSeccion('casos')">Imprimir listado</button>
        </div>
      </div>
      <div class="filters">
        <input id="searchInput" placeholder="Buscar nombre/DNI" oninput="aplicarFiltros()">
        <select id="estadoFilter" onchange="aplicarFiltros()">
          <option value="">Todos</option><option>Abierto</option><option>En Proceso</option><option>Cerrado</option>
        </select>
      </div>
      <div id="tablaCasos"></div>
    </div>
  </div>

  <aside id="sidebarSeguimiento">
    <div class="s-header"><span id="sidebarTitle"></span>
      <div class="inline">
        <button class="btn btn-secondary" onclick="imprimirSeccion('sidebarSeguimiento')">Imprimir</button>
        <button class="btn btn-danger" onclick="cerrarSidebar()">✕</button>
      </div>
    </div>
    <div class="s-body"><div id="timeline"></div></div>
    <div class="seguimiento-form">
      <textarea id="nuevoSeguimiento" rows="3" placeholder="Agregar seguimiento..."></textarea>
      <button class="btn btn-primary" style="width:100%;margin-top:8px" onclick="guardarSeguimiento()">Agregar Seguimiento</button>
    </div>
  </aside>

  <div id="modalCaso" class="modal"><div class="modal-card">
    <div class="modal-head"><h3>Detalle del Caso</h3>
      <div class="inline">
        <button class="btn btn-secondary" onclick="imprimirSeccion('modalCasoBody')">Imprimir</button>
        <button class="btn btn-danger" onclick="cerrarModalCaso()">✕</button>
      </div></div>
    <div class="modal-body" id="modalCasoBody"></div>
    <div class="print-actions">
      <button class="btn btn-danger" onclick="eliminarCaso(casoActual?.id)">Eliminar Caso</button>
    </div>
  </div></div>
  
  <div id="dynamicModal" class="modal"><div class="modal-card">
    <div class="modal-head">
      <h3 id="modalTitle"></h3>
      <div class="inline">
        <button class="btn btn-secondary" onclick="imprimirSeccion('modalFormBody')">Imprimir</button>
        <button class="btn btn-primary" onclick="guardarSeccionTemporal()">Guardar</button>
        <button class="btn btn-danger" onclick="closeModal()">Cancelar</button>
      </div>
    </div>
    <div class="modal-body" id="modalFormBody"></div>
  </div></div>

  <div id="modalExpediente" class="modal"><div class="modal-card">
    <div class="modal-head"><h3>Detalle de Expediente</h3>
      <div class="inline">
        <button class="btn btn-secondary" onclick="imprimirSeccion('modalExpedienteBody')">Imprimir</button>
        <button class="btn btn-danger" onclick="cerrarModalExpediente()">✕</button>
      </div>
    </div>
    <div class="modal-body" id="modalExpedienteBody"></div>
  </div></div>

  <script type="module">
    // ===== Firebase (Firestore y RTDB) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, push, get, child, set, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    function formatFechaHora(date){
      return new Intl.DateTimeFormat("es-AR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:false}).format(date);
    }
    function formatFecha(date){
      return new Intl.DateTimeFormat("es-AR",{day:"2-digit",month:"2-digit",year:"numeric"}).format(date);
    }
    const $ = (id)=>document.getElementById(id);

    // Firebase App 1: proteccion-personas (esta aplicación)
    const app1 = initializeApp({apiKey:"AIzaSyAWlsFqN09y_DAAIKLLIjGjjyR2_rKJIFs",authDomain:"proteccion-personas.firebaseapp.com",projectId:"proteccion-personas"},"app1");
    const rtdb1 = getDatabase(app1);

    // Firebase App 2: causas-defensoria (expedientes externos - Firestore)
    const firebaseConfig = {
      apiKey: "AIzaSyBt6X0u0BpiNPcV2SNPrN-spCmjl2AhZaA",
      authDomain: "causas-defensoria.firebaseapp.com",
      databaseURL: "https://causas-defensoria-default-rtdb.firebaseio.com",
      projectId: "causas-defensoria",
    };
    const app2 = initializeApp(firebaseConfig, "app2");
    const db2 = getFirestore(app2);

    // ===== Estado =====
    let casos=[], casosFiltrados=[], casoActual=null, editandoId=null, lastEditedId=null;
    let causasIndex = {};
    let tempCasoData = {};
    let currentModalId = '';

    // ===== Refs DOM =====
    const formTitle=$('formTitle');
    const expedienteSelect=$('expedienteReferencia'), expedienteInfo=$('expedienteInfo');
    const searchInput=$('searchInput'), estadoFilter=$('estadoFilter'), tablaCasos=$('tablaCasos');
    const totalCasos=$('totalCasos'), casosAbiertos=$('casosAbiertos'), casosProceso=$('casosProceso'), casosCerrados=$('casosCerrados'), listaTramite=$('listaTramite');
    const sidebarSeguimiento=$('sidebarSeguimiento'), sidebarTitle=$('sidebarTitle'), timeline=$('timeline'), nuevoSeguimiento=$('nuevoSeguimiento');
    const modalCaso=$('modalCaso'), modalCasoBody=$('modalCasoBody');
    const dynamicModal = $('dynamicModal'), modalFormBody = $('modalFormBody'), modalTitle = $('modalTitle');
    const validacionMsg=$('validacionMsg');

    // ===== Utilidades =====
    function calcEdad(dateStr){
      if(!dateStr) return null;
      const d=new Date(dateStr), t=new Date();
      let e=t.getFullYear()-d.getFullYear();
      const m=t.getMonth()-d.getMonth();
      if(m<0 || (m===0 && t.getDate()<d.getDate())) e--;
      return e>=0?e:null;
    }
    function setBadge(el, text, level=""){
      el.textContent = text;
      el.classList.remove("badge-ok","badge-warn","badge-danger");
      if(level) el.classList.add(level);
    }
    
    // ===== Eventos =====
    document.addEventListener("DOMContentLoaded", async ()=>{
      await Promise.all([cargarExpedientes(), cargarCasos()]);
    });
    
    // ===== Lógica de Modales Dinámicos =====
    window.openModal = (id)=>{
      currentModalId = id;
      modalFormBody.innerHTML = '';
      const form = $(id + 'Form');
      if (!form) return;

      modalTitle.textContent = form.querySelector('legend')?.textContent || 'Formulario';
      const clonedForm = form.cloneNode(true);
      clonedForm.style.display = 'block';
      modalFormBody.appendChild(clonedForm);
      dynamicModal.classList.add('open');
      
      const formFields = modalFormBody.querySelector('form').elements;
      for (let key in tempCasoData) {
        if (formFields[key]) {
          if (formFields[key].type === 'checkbox') {
            formFields[key].checked = tempCasoData[key];
          } else {
            formFields[key].value = tempCasoData[key];
          }
        }
      }

      // Re-asociar listeners a campos dinámicos
      ['fechaNacimientoNNA', 'faFechaNac', 'faResidenciaAnos'].forEach(fieldId => {
        const el = clonedForm.querySelector('#' + fieldId);
        if(el) el.addEventListener('input', updateModalBadges);
      });
      if(clonedForm.querySelector('#expedienteReferencia')) {
          const select = clonedForm.querySelector('#expedienteReferencia');
          select.innerHTML = expedienteSelect.innerHTML;
          select.value = tempCasoData.expedienteReferencia || '';
          select.addEventListener("change", (e)=>{
              const numeroCausa = e.target.value;
              const info = clonedForm.querySelector('#expedienteInfo');
              if(!numeroCausa){ info.textContent=""; return; }
              const c = causasIndex[numeroCausa];
              info.textContent = c ? `Seleccionado: ${c.numCausa || numeroCausa} — ${c.caratula || ''}` : "";
          });
          const info = clonedForm.querySelector('#expedienteInfo');
          if(select.value) {
            const c = causasIndex[select.value];
            info.textContent = c ? `Seleccionado: ${c.numCausa || select.value} — ${c.caratula || ''}` : "";
          }
      }
      updateModalBadges();
    };
    
    window.closeModal = ()=>{
      dynamicModal.classList.remove('open');
      modalFormBody.innerHTML = '';
    };

    window.guardarSeccionTemporal = ()=>{
      const formFields = modalFormBody.querySelector('form').elements;
      let sectionData = {};
      for(let i = 0; i < formFields.length; i++){
        const field = formFields[i];
        if (field.id) {
          if (field.type === 'checkbox') {
            sectionData[field.id] = field.checked;
          } else {
            sectionData[field.id] = field.value;
          }
        }
      }
      Object.assign(tempCasoData, sectionData);
      closeModal();
      document.getElementById('badge-' + currentModalId).style.display = 'block';
    };

    function updateModalBadges() {
      const form = modalFormBody.querySelector('form');
      if (!form) return;
      const fechaNacNNA = form.querySelector('#fechaNacimientoNNA')?.value;
      const fechaNacFA = form.querySelector('#faFechaNac')?.value;
      const residenciaAnos = form.querySelector('#faResidenciaAnos')?.value;
      
      const edadNNA = calcEdad(fechaNacNNA);
      const edadFA = calcEdad(fechaNacFA);
      const anos = parseInt(residenciaAnos, 10);
      
      const edadNNAInfoEl = form.querySelector('#edadNNAInfo');
      if (edadNNAInfoEl) setBadge(edadNNAInfoEl, `Edad NNA: ${edadNNA} años`, edadNNA != null ? "badge-ok" : "");
      
      const edadFAInfoEl = form.querySelector('#edadFAInfo');
      if (edadFAInfoEl) setBadge(edadFAInfoEl, `Edad referente: ${edadFA} años`, edadFA != null && edadFA >= 25 ? "badge-ok" : "badge-danger");
      
      const difEdadInfoEl = form.querySelector('#difEdadInfo');
      if (difEdadInfoEl) {
        if (edadNNA != null && edadFA != null) {
          const diff = edadFA - edadNNA;
          setBadge(difEdadInfoEl, `Diferencia con NNA: ${diff} años`, diff >= 15 ? "badge-ok" : "badge-danger");
        } else {
          setBadge(difEdadInfoEl, "Diferencia con NNA: —");
        }
      }
      
      const residenciaInfoEl = form.querySelector('#residenciaInfo');
      if (residenciaInfoEl) {
        if (!isNaN(anos)) {
          setBadge(residenciaInfoEl, `Residencia: ${anos} años`, anos >= 2 ? "badge-ok" : "badge-warn");
        } else {
          setBadge(residenciaInfoEl, "Residencia: —");
        }
      }
      
      // Update checkbox states for requirements
      const reqEdad = form.querySelector('#reqEdad');
      if (reqEdad && edadFA != null) reqEdad.checked = edadFA >= 25;
      
      const reqDiferenciaEdad = form.querySelector('#reqDiferenciaEdad');
      if (reqDiferenciaEdad && edadNNA != null && edadFA != null) reqDiferenciaEdad.checked = (edadFA - edadNNA) >= 15;
      
      const reqDomicilio = form.querySelector('#reqDomicilio');
      if (reqDomicilio && !isNaN(anos)) reqDomicilio.checked = anos >= 2;
    }

    window.resetForm = ()=>{
      tempCasoData = {};
      document.querySelectorAll('.reg-card .badge').forEach(el => el.style.display = 'none');
      if(expedienteSelect) expedienteSelect.value = "";
      if(expedienteInfo) expedienteInfo.textContent = "";
      closeModal();
    };

    // ===== Cargar expedientes desde Firestore =====
    async function cargarExpedientes() {
      expedienteSelect.innerHTML = "<option value=''>-- Cargando expedientes... --</option>";
      causasIndex = {};
      try {
        const querySnapshot = await getDocs(collection(db2, "causas"));
        expedienteSelect.innerHTML = "<option value=''>-- Seleccione --</option>";
        
        querySnapshot.forEach((doc) => {
          const val = doc.data();
          if (val && val.numCausa) {
            causasIndex[val.numCausa] = { ...val, firebaseId: doc.id };
            const opt = document.createElement("option");
            opt.value = val.numCausa;
            opt.textContent = `Causa ${val.numCausa}` + (val.caratula ? ` – ${val.caratula}` : "");
            expedienteSelect.appendChild(opt);
          }
        });
      } catch (error) {
        console.error("Error al cargar expedientes desde Firestore:", error);
        expedienteSelect.innerHTML = "<option value=''>-- Error al cargar --</option>";
      }
    }

    // ===== Guardar / Actualizar caso (RTDB app1:/casos) =====
    window.guardarCaso = async (e)=>{
      if(!tempCasoData.nombreNNA || !tempCasoData.nombreCompletoNNA){
        alert("Los campos de nombre del NNA son obligatorios. Por favor, complete los módulos 'Datos del NNA' y 'Información Adicional'.");
        return;
      }

      const edadN = calcEdad(tempCasoData.fechaNacimientoNNA);
      const edadF = calcEdad(tempCasoData.faFechaNac);
      const anosRes = parseInt(tempCasoData.faResidenciaAnos,10);
      if(edadF!=null && edadF<25){ alert("No se puede guardar: el referente debe tener 25 años o más (Art. 18)."); return; }
      if(edadN!=null && edadF!=null && (edadF-edadN)<15){ alert("No se puede guardar: la diferencia de edad con el NNA debe ser de 15 años o más (Art. 18)."); return; }
      if(!isNaN(anosRes) && anosRes<2){ alert("No se puede guardar: la residencia en Misiones debe ser de 2 años o más (Art. 18)."); return; }

      const etapas = {
        convocatoria: !!tempCasoData.etapaConvocatoria,
        evaluacion: !!tempCasoData.etapaEvaluacion,
        capacitacion: !!tempCasoData.etapaCapacitacion,
        inscripcion: !!tempCasoData.etapaInscripcion,
        plan: !!tempCasoData.etapaPlan
      };
      const requisitos = {
        reqDomicilio: !!tempCasoData.reqDomicilio,
        reqEdad: !!tempCasoData.reqEdad,
        reqDiferenciaEdad: !!tempCasoData.reqDiferenciaEdad,
        reqPenales: !!tempCasoData.reqPenales,
        reqAlimentaria: !!tempCasoData.reqAlimentaria,
        reqPsicofisico: !!tempCasoData.reqPsicofisico,
        reqIngresos: !!tempCasoData.reqIngresos,
        reqVivienda: !!tempCasoData.reqVivienda,
        reqCapacitacion: !!tempCasoData.reqCapacitacion,
        reqAcuerdo: !!tempCasoData.reqAcuerdo
      };
      const inhabilidades = {
        inhDelitos: !!tempCasoData.inhDelitos,
        inhMedidas: !!tempCasoData.inhMedidas,
        inhRespParental: !!tempCasoData.inhRespParental,
        inhTutela: !!tempCasoData.inhTutela
      };
      const medidas = {
        guiaAsistencia: !!tempCasoData.medidaGuiaAsistencia,
        asistenciaSalud: !!tempCasoData.medidaAsistenciaSalud,
        inscripcionEscolar: !!tempCasoData.medidaInscripcionEscolar,
        exclusionAgresor: !!tempCasoData.medidaExclusionAgresor,
        otros: !!tempCasoData.medidaOtros
      }
      
      const data = {
        nombreNNA: tempCasoData.nombreNNA,
        dniNNA: tempCasoData.dniNNA,
        fechaNacimientoNNA: tempCasoData.fechaNacimientoNNA,
        generoNNA: tempCasoData.generoNNA,
        centroVida: tempCasoData.centroVida,
        vinculosFraternos: tempCasoData.vinculosFraternos,
        situacionVulneracion: tempCasoData.situacionVulneracion,
        tipoMedida: tempCasoData.tipoMedida,
        autoridadInterviniente: tempCasoData.autoridadInterviniente,
        fechaMedida: tempCasoData.fechaMedida,
        fechaIngresoSAF: tempCasoData.fechaIngresoSAF,
        tipoFamilia: tempCasoData.tipoFamilia,
        rufAAFA: tempCasoData.rufAAFA,
        faNombre: tempCasoData.faNombre,
        faDni: tempCasoData.faDni,
        faFechaNac: tempCasoData.faFechaNac,
        faDomicilio: tempCasoData.faDomicilio,
        faContacto: tempCasoData.faContacto,
        faResidenciaAnos: tempCasoData.faResidenciaAnos,
        etapas, planIntervencion: tempCasoData.planIntervencion,
        causalEgreso: tempCasoData.causalEgreso, fechaEgreso: tempCasoData.fechaEgreso,
        obsDerechos: tempCasoData.obsDerechos,
        requisitos, inhabilidades,
        estadoCaso: tempCasoData.estadoCaso,
        expedienteReferencia: tempCasoData.expedienteReferencia || "",
        lugarInstitucionalizacion: tempCasoData.lugarInstitucionalizacion,
        contactoInstitucionalizacion: tempCasoData.contactoInstitucionalizacion,
        nombreCompletoNNA: tempCasoData.nombreCompletoNNA,
        nacionalidadNNA: tempCasoData.nacionalidadNNA,
        identidadCulturalNNA: tempCasoData.identidadCulturalNNA,
        opinionNNA: tempCasoData.opinionNNA,
        nombreMadre: tempCasoData.nombreMadre,
        nombrePadre: tempCasoData.nombrePadre,
        vinculoFamiliar: tempCasoData.vinculoFamiliar,
        obsFamilia: tempCasoData.obsFamilia,
        medidasAplicadas: medidas,
        obsMedida: tempCasoData.obsMedida,
        asistenciaLetrada: tempCasoData.asistenciaLetrada,
        actoInfractor: tempCasoData.actoInfractor,
        infoFamilia: tempCasoData.infoFamilia
      };

      if(editandoId){
        const targetRef = ref(rtdb1, "casos/" + editandoId);
        const snap = await get(targetRef);
        let historial = (snap.exists() && snap.val().historial) ? snap.val().historial : [];
        historial.push({fecha:formatFechaHora(new Date()), accion:"Edición del caso"});
        await update(targetRef, {...data, historial});
        lastEditedId = editandoId;
        editandoId = null;
        formTitle.textContent = "Nuevo Caso";
      }else{
        const nuevo = {
          ...data,
          fechaRegistro: formatFecha(new Date()),
          seguimientos: tempCasoData.seguimientoInicial ? [{fecha:formatFechaHora(new Date()), texto: tempCasoData.seguimientoInicial}] : [],
          historial: [{fecha:formatFechaHora(new Date()), accion:"Creación del caso"}]
        };
        const res = await push(ref(rtdb1,"casos"), nuevo);
        lastEditedId = res.key;
      }
      resetForm();
      await cargarCasos();
      showTab('casos');
    }

    // ===== Cargar casos (RTDB app1:/casos) =====
    async function cargarCasos(){
      casos = [];
      const s = await get(child(ref(rtdb1),"casos"));
      if(s.exists()){
        const data = s.val() || {};
        casos = Object.entries(data).map(([id, val])=>({id, ...(val||{})}));
      }
      aplicarFiltros();
      actualizarDashboard();
      renderTramite();
    }

    function aplicarFiltros(){
      const q = (searchInput?.value||"").toLowerCase();
      const est = (estadoFilter?.value||"");
      casosFiltrados = casos
        .filter(c => (c.nombreNNA||"").toLowerCase().includes(q) || (c.dniNNA||"").includes(q))
        .filter(c => !est || c.estadoCaso===est);
      mostrarCasos();
    }

    function getExpDisplay(numeroCausa){
      if(!numeroCausa) return "";
      const c = causasIndex[numeroCausa];
      return c ? (c.caratula || c.numCausa || "") : (numeroCausa || "");
    }

    function mostrarCasos(){
      if(!casosFiltrados.length){ tablaCasos.innerHTML="<p>Sin casos</p>"; return; }
      let h = "<table class='cases-table'><tr><th></th><th>Nombre</th><th>Estado</th><th>SAF</th><th>Expediente</th><th>Acciones</th></tr>";
      for(const c of casosFiltrados){
        const cls = c.estadoCaso==="Abierto" ? "status-abierto" : (c.estadoCaso==="Cerrado" ? "status-cerrado" : "status-en");
        const expTxt = c.expedienteReferencia ? getExpDisplay(c.expedienteReferencia) : "";
        const expHtml = c.expedienteReferencia ? `<a class="link" href="#" onclick="verExpediente('${c.expedienteReferencia}')">${expTxt}</a>` : "";
        const safBadge = c.tipoFamilia ? `<span class="chip">${c.tipoFamilia}</span>` : "";
        h += `<tr id="row-${c.id}">
                <td><input type="checkbox" onchange="toggleSidebar('${c.id}',this.checked)"></td>
                <td>${c.nombreNNA||""}</td>
                <td class="${cls}">${c.estadoCaso||""}</td>
                <td>${safBadge}</td>
                <td>${expHtml}</td>
                <td class="actions">
                  <button class="btn btn-ghost" onclick="editarCaso('${c.id}')">Editar</button>
                  <button class="btn btn-ghost" onclick="verCaso('${c.id}')">Vista</button>
                  <button class="btn btn-danger" onclick="eliminarCaso('${c.id}')">Eliminar</button>
                </td>
              </tr>`;
      }
      h += "</table>";
      tablaCasos.innerHTML = h;

      if(lastEditedId){
        const row = $('row-'+lastEditedId);
        if(row){ row.classList.add('row-highlight'); row.scrollIntoView({behavior:'smooth', block:'center'}); }
        lastEditedId = null;
      }
    }

    function actualizarDashboard(){
      totalCasos.textContent = casos.length;
      casosAbiertos.textContent = casos.filter(c=>c.estadoCaso==="Abierto").length;
      casosProceso.textContent = casos.filter(c=>c.estadoCaso==="En Proceso").length;
      casosCerrados.textContent = casos.filter(c=>c.estadoCaso==="Cerrado").length;
    }

    function renderTramite(){
      listaTramite.innerHTML="";
      casos.filter(c=>c.estadoCaso==="En Proceso").forEach(c=>{
        const li=document.createElement("li");
        const expTxt = c.expedienteReferencia ? getExpDisplay(c.expedienteReferencia) : "-";
        li.innerHTML = `<b>${c.nombreNNA||"Sin nombre"}</b> · Exp: ${expTxt} ` + (c.tipoFamilia? `· <i>${c.tipoFamilia}</i>`:"");
        listaTramite.appendChild(li);
      });
    }

    // ===== Editar (carga en formulario) =====
    window.editarCaso = (id)=>{
      const c = casos.find(x=>x.id===id); if(!c) return;
      editandoId = id; formTitle.textContent = "Editar Caso";
      tempCasoData = {
        nombreNNA: c.nombreNNA || "", dniNNA: c.dniNNA || "", fechaNacimientoNNA: c.fechaNacimientoNNA || "", generoNNA: c.generoNNA || "",
        centroVida: c.centroVida || "", vinculosFraternos: c.vinculosFraternos || "", situacionVulneracion: c.situacionVulneracion || "",
        tipoMedida: c.tipoMedida || "", autoridadInterviniente: c.autoridadInterviniente || "", fechaMedida: c.fechaMedida || "", fechaIngresoSAF: c.fechaIngresoSAF || "",
        tipoFamilia: c.tipoFamilia || "", rufAAFA: c.rufAAFA || "", faNombre: c.faNombre || "", faDni: c.faDni || "", faFechaNac: c.faFechaNac || "",
        faDomicilio: c.faDomicilio || "", faContacto: c.faContacto || "", faResidenciaAnos: c.faResidenciaAnos || "",
        etapaConvocatoria: !!(c.etapas?.convocatoria), etapaEvaluacion: !!(c.etapas?.evaluacion), etapaCapacitacion: !!(c.etapas?.capacitacion),
        etapaInscripcion: !!(c.etapas?.inscripcion), etapaPlan: !!(c.etapas?.plan), planIntervencion: c.planIntervencion || "",
        causalEgreso: c.causalEgreso || "", fechaEgreso: c.fechaEgreso || "", obsDerechos: c.obsDerechos || "",
        reqDomicilio: !!(c.requisitos?.reqDomicilio), reqEdad: !!(c.requisitos?.reqEdad), reqDiferenciaEdad: !!(c.requisitos?.reqDiferenciaEdad),
        reqPenales: !!(c.requisitos?.reqPenales), reqAlimentaria: !!(c.requisitos?.reqAlimentaria), reqPsicofisico: !!(c.requisitos?.reqPsicofisico),
        reqIngresos: !!(c.requisitos?.reqIngresos), reqVivienda: !!(c.requisitos?.reqVivienda), reqCapacitacion: !!(c.requisitos?.reqCapacitacion),
        reqAcuerdo: !!(c.requisitos?.reqAcuerdo), inhDelitos: !!(c.inhabilidades?.inhDelitos), inhMedidas: !!(c.inhabilidades?.inhMedidas),
        inhRespParental: !!(c.inhabilidades?.inhRespParental), inhTutela: !!(c.inhabilidades?.inhTutela), estadoCaso: c.estadoCaso || "Abierto",
        expedienteReferencia: c.expedienteReferencia || "", lugarInstitucionalizacion: c.lugarInstitucionalizacion || "", contactoInstitucionalizacion: c.contactoInstitucionalizacion || "",
        nombreCompletoNNA: c.nombreCompletoNNA || "", nacionalidadNNA: c.nacionalidadNNA || "", identidadCulturalNNA: c.identidadCulturalNNA || "",
        opinionNNA: c.opinionNNA || "", nombreMadre: c.nombreMadre || "", nombrePadre: c.nombrePadre || "", vinculoFamiliar: c.vinculoFamiliar || "",
        obsFamilia: c.obsFamilia || "", medidasAplicadas: c.medidasAplicadas || {}, obsMedida: c.obsMedida || "", asistenciaLetrada: c.asistenciaLetrada || "",
        actoInfractor: c.actoInfractor || "", infoFamilia: c.infoFamilia || ""
      };
      document.querySelectorAll('.reg-card .badge').forEach(el => el.style.display = 'block');
      showTab('registro');
    };

    // ===== Sidebar Seguimiento =====
    window.toggleSidebar = async (id, ch)=>{
      if(ch){
        const s = await get(child(ref(rtdb1),"casos/"+id));
        if(s.exists()){
          casoActual = {id, ...(s.val()||{})};
          sidebarTitle.textContent = "Seguimiento · " + (casoActual.nombreNNA||"");
          renderTimeline();
          sidebarSeguimiento.classList.add("active");
        }
      }else cerrarSidebar();
    };

    function renderTimeline(){
      const arr = Array.isArray(casoActual?.seguimientos) ? casoActual.seguimientos : [];
      timeline.innerHTML = arr.length
        ? arr.map((s,i)=>`<div class='timeline-item'><div class='date'>${s.fecha}</div><div>${s.texto}</div><button class='delete-btn' title='Eliminar' onclick='eliminarSeguimiento(${i})'>✕</button></div>`).join("")
        : "<p>Sin seguimientos</p>";
    }

    window.guardarSeguimiento = async ()=>{
      if(!casoActual || !nuevoSeguimiento.value) return;
      const arr = Array.isArray(casoActual.seguimientos) ? casoActual.seguimientos : [];
      arr.push({fecha:formatFechaHora(new Date()), texto:nuevoSeguimiento.value});
      await update(ref(rtdb1,"casos/"+casoActual.id), {seguimientos:arr});
      casoActual.seguimientos = arr;
      nuevoSeguimiento.value = "";
      renderTimeline();
    };

    window.eliminarSeguimiento = async (i)=>{
      if(!casoActual) return;
      const arr = Array.isArray(casoActual.seguimientos) ? casoActual.seguimientos : [];
      arr.splice(i,1);
      await update(ref(rtdb1,"casos/"+casoActual.id), {seguimientos:arr});
      casoActual.seguimientos = arr;
      renderTimeline();
    };

    window.cerrarSidebar = ()=>{
      sidebarSeguimiento.classList.remove("active");
      document.querySelectorAll("#tablaCasos input[type=checkbox]").forEach(c=>c.checked=false);
    };

    // ===== Vista (modal) del Caso =====
    window.verCaso = async (id)=>{
      const s = await get(child(ref(rtdb1),"casos/"+id));
      if(!s.exists()) return;
      casoActual = {id, ...(s.val()||{})};
      const historialHTML = (casoActual.historial||[]).map(h=>`<p><span class='status-en'>${h.fecha}</span>: ${h.accion}</p>`).join("") || "<p>Sin historial</p>";
      const seguimientosHTML = (casoActual.seguimientos||[]).map(sg=>`<p><span class='status-en'>${sg.fecha}</span>: ${sg.texto}</p>`).join("") || "<p>Sin seguimiento</p>";
      const expHtml = casoActual.expedienteReferencia ? `<a class="link" href="#" onclick="verExpediente('${casoActual.expedienteReferencia}')">${getExpDisplay(casoActual.expedienteReferencia)}</a>` : "-";
      const reqList = casoActual.requisitos ? Object.entries(casoActual.requisitos).filter(([k,v])=>v).map(([k])=>k.replace('req','').replace(/[A-Z]/g,' $&')).join(', ') : '-';
      const inhList = casoActual.inhabilidades ? Object.entries(casoActual.inhabilidades).filter(([k,v])=>v).map(([k])=>k.replace('inh','').replace(/[A-Z]/g,' $&')).join(', ') : '-';
      const edadN = calcEdad(casoActual.fechaNacimientoNNA);
      const edadF = calcEdad(casoActual.faFechaNac);
      const diff = (edadN!=null && edadF!=null) ? (edadF-edadN) : null;
      modalCasoBody.innerHTML = `
        <div class='section'>
          <h4>Datos del NNA</h4>
          <div class="form-row">
            <div><b>Nombre:</b> ${casoActual.nombreNNA||""}</div>
            <div><b>DNI:</b> ${casoActual.dniNNA||""}</div>
          </div>
          <div class="form-row">
            <div><b>Fecha Nac.:</b> ${casoActual.fechaNacimientoNNA||""} ${edadN!=null?`<span class='badge badge-ok'>${edadN} años</span>`:""}</div>
            <div><b>Género:</b> ${casoActual.generoNNA||""}</div>
          </div>
          <div class="form-row">
            <div><b>Centro de vida:</b> ${casoActual.centroVida||""}</div>
            <div><b>Vínculos fraternos:</b> ${casoActual.vinculosFraternos||""}</div>
          </div>
          <div class="form-row">
            <div><b>Estado:</b> ${casoActual.estadoCaso||""}</div>
            <div><b>Exp. ref.:</b> ${expHtml}</div>
          </div>
          <div class="form-row">
            <div><b>Lugar de institucionalización:</b> ${casoActual.lugarInstitucionalizacion||""}</div>
            <div><b>Contacto institucionalización:</b> ${casoActual.contactoInstitucionalizacion||""}</div>
          </div>
        </div>
        <div class='section'>
          <h4>Medida y SAF</h4>
          <div class="form-row">
            <div><b>Tipo de medida:</b> ${casoActual.tipoMedida||""}</div>
            <div><b>Autoridad:</b> ${casoActual.autoridadInterviniente||""}</div>
          </div>
          <div class="form-row">
            <div><b>Fecha medida:</b> ${casoActual.fechaMedida||""}</div>
            <div><b>Ingreso SAF:</b> ${casoActual.fechaIngresoSAF||""}</div>
          </div>
          <div class="form-row">
            <div><b>Tipo familia:</b> ${casoActual.tipoFamilia||""}</div>
            <div><b>RUFAAFA:</b> ${casoActual.rufAAFA||""}</div>
          </div>
          <div class="form-row">
            <div><b>Referente:</b> ${casoActual.faNombre||""}</div>
            <div><b>DNI Referente:</b> ${casoActual.faDni||""}</div>
          </div>
          <div class="form-row">
            <div><b>Fecha nac. referente:</b> ${casoActual.faFechaNac||""} ${edadF!=null?`<span class='badge ${edadF>=25?'badge-ok':'badge-danger'}'>${edadF} años</span>`:""}</div>
            <div><b>Contacto FA:</b> ${casoActual.faContacto||""}</div>
          </div>
          <div class="form-row">
            <div><b>Domicilio FA:</b> ${casoActual.faDomicilio||""}</div>
            <div><b>Residencia en Misiones:</b> ${casoActual.faResidenciaAnos||"-"} ${casoActual.faResidenciaAnos?`<span class='badge ${(parseInt(casoActual.faResidenciaAnos,10)>=2)?'badge-ok':'badge-warn'}'>${casoActual.faResidenciaAnos} años</span>`:""}</div>
          </div>
          <div><b>Etapas:</b> ${Object.entries(casoActual.etapas||{}).filter(([k,v])=>v).map(([k])=>k).join(', ')||'-'}</div>
          <div style="margin-top:6px"><b>Plan de intervención:</b><br>${(casoActual.planIntervencion||"").replace(/\n/g,"<br>")}</div>
          ${diff!=null?`<div style="margin-top:6px"><b>Diferencia de edad referente/NNA:</b> ${diff} años ${diff>=15?'<span class="badge badge-ok">OK</span>':'<span class="badge badge-danger">Insuficiente</span>'}</div>`:""}
        </div>
        <div class='section'>
          <h4>RUFAAFA</h4>
          <p><b>Requisitos cumplidos:</b> ${reqList}</p>
          <p><b>Inhabilidades (negativas):</b> ${inhList}</p>
        </div>
        <div class='section'>
          <h4>Situación</h4>
          <p>${(casoActual.situacionVulneracion||"").replace(/\n/g,"<br>")}</p>
          <h4 style="margin-top:8px">Observaciones de derechos</h4>
          <p>${(casoActual.obsDerechos||"").replace(/\n/g,"<br>")}</p>
        </div>
        <div class='section'>
          <h4>Seguimientos</h4>
          ${seguimientosHTML}
        </div>
        <div class='section'>
          <h4>Egreso</h4>
          <div class="form-row">
            <div><b>Causal:</b> ${casoActual.causalEgreso||"-"}</div>
            <div><b>Fecha:</b> ${casoActual.fechaEgreso||"-"}</div>
          </div>
        </div>
        <div class='section'>
          <h4>Historial de cambios</h4>
          ${historialHTML}
        </div>`;
      modalCaso.classList.add("open");
    };

    window.cerrarModalCaso = ()=> modalCaso.classList.remove("open");

    window.eliminarCaso = async (id)=>{
      const targetId = id || (casoActual && casoActual.id);
      if(!targetId) return;
      if(confirm("¿Eliminar caso?")){
        await remove(ref(rtdb1,"casos/"+targetId));
        modalCaso.classList.remove("open");
        await cargarCasos();
      }
    };

    // ===== Modal Expediente =====
    window.verExpediente = async (numeroCausa)=>{
      const causaDoc = Object.values(causasIndex).find(c => c.numCausa === numeroCausa);
      if(!causaDoc) {
        alert("Detalles del expediente no encontrados.");
        return;
      }
      const seguimientoDocs = await getDocs(collection(db2, "causas", causaDoc.firebaseId, "seguimiento"));
      const segs = seguimientoDocs.docs
        .map(doc => {
          const s = doc.data();
          return `<p><span style="color:#004085;font-weight:bold">${s.fecha}:</span> ${s.texto}</p>`;
        })
        .join("") || "<p style='color:gray'>Sin seguimientos registrados</p>";
      $('modalExpedienteBody').innerHTML = `
        <div class='section'>
          <h4>Datos del Expediente</h4>
          <p><b>Número de Causa:</b> ${causaDoc.numCausa||""}</p>
          <p><b>Carátula:</b> ${causaDoc.caratula||""}</p>
          <p><b>Fecha de Registro:</b> ${causaDoc.fecha||""}</p>
          <p><b>Estado:</b> ${causaDoc.estado||""}</p>
          <p><b>Detalle del Registro:</b><br>${(causaDoc.detalle||"").replace(/\n/g,"<br>")}</p>
        </div>
        <div class='section'>
          <h4>Seguimientos</h4>
          ${segs}
        </div>`;
      $('modalExpediente').classList.add("open");
    };
    window.cerrarModalExpediente = ()=>$('modalExpediente').classList.remove("open");
    // ===== Utilidades de impresión/exportación =====
    window.imprimirSeccion = (id)=>{
      const el = document.getElementById(id);
      if(!el) return;
      const w = window.open("", "_blank");
      const styles = document.querySelector('style')?.outerHTML || "";
      w.document.write(`<html><head><title>Imprimir</title>${styles}</head><body>${el.innerHTML}</body></html>`);
      w.document.close();
      w.focus();
      w.print();
    };
    window.exportarJSON = ()=>{
      const blob = new Blob([JSON.stringify(casos,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'casos.json';
      a.click();
      URL.revokeObjectURL(url);
    };
    // ===== Tabs =====
    window.showTab = (id, e)=>{
      document.querySelectorAll(".tab-content").forEach(x=>x.classList.remove("active"));
      const tab = document.getElementById(id);
      if(tab) tab.classList.add("active");
    };
  </script>
</body>
</html>
