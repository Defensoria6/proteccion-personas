<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Protección de Personas — SAF (Ley II N° 36) · RTDB</title>
  <style>
    :root{
      --brand:#004085;--bg: #a3c8ff;--card:#fff;--line:#e3e6ea;--muted:#6b7280;
      --accent:#0d6efd;--accent-dark:#0b5ed7;--ok:#198754;--warn:#ea580c;--danger:#dc3545;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:'Segoe UI',system-ui,Arial,sans-serif;background:var(--bg);margin:0;padding:20px;color:#111}
    .container{max-width:1300px;margin:0 auto;background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden}
    /* --- Navegación como tarjetas --- */
    .nav-wrap{background:white;border-bottom:1px solid var(--line);padding:16px}
    .nav-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .nav-card{display:flex;flex-direction:column;gap:10px;background:#fff;border:1px solid var(--line);border-radius:12px;padding:14px;transition:transform .06s ease, box-shadow .2s ease;cursor:pointer}
    .nav-card:hover{box-shadow:0 6px 20px rgba(0,0,0,.06);transform:translateY(-1px)}
    .nav-card h4{margin:0;color:var(--brand)}
    .nav-card p{margin:0;color:var(--muted);font-size:.9rem;line-height:1.35}
    .nav-actions{display:flex;gap:8px;flex-wrap:wrap}
    .nav-btn{padding:10px 12px;border:none;border-radius:10px;background:var(--accent);color:#fff;font-weight:700}
    .nav-btn:active{transform:translateY(1px)}
    .tab-content{display:none;padding:22px}.tab-content.active{display:block}
    /* --- Layouts y tablas --- */
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .form-row.full{grid-template-columns:1fr}
    .subgrid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    label{display:block;margin:6px 0;font-weight:600}
    input,select,textarea{width:100%;padding:10px;border:1px solid #cfd6de;border-radius:8px;background:#fff}
    textarea{min-height:90px;resize:vertical}
    .small{font-size:.85rem;color:var(--muted)}
    .fieldset{border:1px dashed var(--line);border-radius:12px;padding:14px;margin:12px 0;background:#fff}
    .fieldset legend{padding:0 6px;color:var(--brand);font-weight:700}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
    .chip{padding:4px 10px;border:1px solid var(--line);border-radius:999px;font-size:.85rem;background:#fff}
    .btn{padding:9px 14px;border:none;border-radius:10px;cursor:pointer;font-weight:700}
    .btn-primary{background:var(--brand);color:#fff}.btn-secondary{background:#6c757d;color:#fff}
    .btn-danger{background:var(--danger);color:#fff}.btn-ghost{background:#fff;border:1px solid var(--line);color:#111}
    .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .cases-table{width:100%;border-collapse:collapse;margin-top:14px}
    .cases-table th,.cases-table td{padding:10px;border-bottom:1px solid var(--line)}.cases-table th{background:var(--brand);color:#fff}
    .actions{display:flex;gap:6px;flex-wrap:wrap}
    .status-abierto{color:var(--ok);font-weight:bold}.status-en{color:#0ea5e9;font-weight:bold}.status-cerrado{color:var(--danger);font-weight:bold}
    .row-highlight{animation:hilite 2.2s ease-in-out 1; background:#fff9c4 !important}
    @keyframes hilite{0%{background:#fff9c4} 100%{background:transparent}}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .section{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff}
    /* --- Sidebar Seguimiento --- */
    #sidebarSeguimiento{position:fixed;top:0;right:-460px;width:460px;height:100%;background:#fff;box-shadow:-2px 0 14px rgba(0,0,0,.15);transition:right .28s;z-index:1200;display:flex;flex-direction:column}
    #sidebarSeguimiento.active{right:0}
    #sidebarSeguimiento .s-header{background:var(--brand);color:#fff;padding:14px;display:flex;justify-content:space-between;align-items:center}
    #sidebarSeguimiento .s-body{padding:16px;overflow:auto;flex:1}
    .timeline-item{border-left:3px solid var(--brand);margin-left:10px;padding-left:12px;margin-bottom:12px;position:relative}
    .timeline-item .date{font-size:.82rem;color:var(--muted)}.timeline-item .delete-btn{position:absolute;right:0;top:0;background:none;border:none;color:var(--danger);cursor:pointer}
    .seguimiento-form{border-top:1px solid var(--line);padding:14px;background:#fafbfc}
    /* --- Modales --- */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1300;align-items:center;justify-content:center;padding:20px}
    .modal.open{display:flex}.modal-card{width:min(980px,96vw);max-height:88vh;background:#fff;border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
    .modal-head{background:var(--brand);color:#fff;padding:14px;display:flex;justify-content:space-between;align-items:center}
    .modal-body{padding:18px;overflow:auto}
    .print-actions{padding:12px;display:flex;justify-content:flex-end;gap:8px;border-top:1px solid var(--line)}
    .filters{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    .filters input,.filters select{padding:8px;border-radius:8px;border:1px solid var(--line)}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:.8rem;border:1px solid var(--line);background:#fff}
    .badge-ok{color:var(--ok);border-color:var(--ok)} .badge-warn{color:var(--warn);border-color:var(--warn)} .badge-danger{color:var(--danger);border-color:var(--danger)}
    /* --- Responsividad extra --- */
    @media (max-width: 1140px){ .nav-grid{grid-template-columns:1fr 1fr} }
    @media (max-width: 760px){
      body { padding: 8px }
      .container { border-radius: 10px }
      .nav-grid{grid-template-columns:1fr}
      .form-row, .subgrid-3 { grid-template-columns: 1fr }
      .grid-2 { grid-template-columns: 1fr }
      .nav-card{padding:12px}
      h1,h2,h3,h4{font-size:1rem}
      .btn{padding:8px 10px;font-size:.95rem}
      .cases-table{display:block;overflow-x:auto}
      #sidebarSeguimiento{width:100%}
      .modal-card{width:100%;height:95vh;border-radius:0}
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Navegación como tarjetas con resumen -->
    <div class="nav-wrap">
      <div class="nav-grid">
        <div class="nav-card" onclick="showTab('inicio',event)">
          <h4>Panel de Inicio</h4>
          <p>Resumen en tiempo real: totales de casos, estados y lista rápida de trámites.</p>
          <div class="nav-actions">
            <button class="nav-btn">Abrir Panel</button>
          </div>
        </div>
        <div class="nav-card" onclick="showTab('registro',event)">
          <h4>Nuevo Caso</h4>
          <p>Registre un caso de SAF con validaciones automáticas según la Ley II N° 36.</p>
          <div class="nav-actions">
            <button class="nav-btn">Crear Caso</button>
          </div>
        </div>
        <div class="nav-card" onclick="showTab('casos',event)">
          <h4>Casos Registrados</h4>
          <p>Listado filtrable, vista detallada, edición, seguimiento y eliminación.</p>
          <div class="nav-actions">
            <button class="nav-btn">Ver Listado</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Panel de Inicio -->
    <div id="inicio" class="tab-content active">
      <h2>Panel de Inicio</h2>
      <p class="small" style="background:#fff3cd;padding:10px;border-radius:10px">
        ℹ️ <b>Ayuda:</b> Use las tarjetas superiores para navegar entre paneles.
      </p>
      <div class="grid-2">
        <div class="section" id="inicioLeft">
          <h4>Totales</h4>
          <p>Total: <strong id="totalCasos">0</strong></p>
          <p class="status-abierto">Abiertos: <strong id="casosAbiertos">0</strong></p>
          <p class="status-en">En Proceso: <strong id="casosProceso">0</strong></p>
          <p class="status-cerrado">Cerrados: <strong id="casosCerrados">0</strong></p>
          <div style="margin-top:8px" class="inline">
            <button class="btn btn-primary" onclick="imprimirSeccion('inicio')">Imprimir Panel</button>
          </div>
        </div>
        <div class="section" id="inicioRight">
          <h4>Casos en trámite</h4>
          <ul id="listaTramite" style="max-height:300px;overflow:auto;margin:0;padding-left:16px"></ul>
        </div>
      </div>
    </div>

    <!-- Nuevo Caso -->
    <div id="registro" class="tab-content">
      <h2 id="formTitle">Nuevo Caso</h2>
      <form id="casoForm">
        <!-- Datos del NNA -->
        <fieldset class="fieldset">
          <legend>Datos del NNA</legend>
          <div class="form-row">
            <div><label>Nombre *</label><input id="nombreNNA" required></div>
            <div><label>DNI</label><input id="dniNNA"></div>
          </div>
          <div class="form-row">
            <div><label>Fecha nac.</label><input type="date" id="fechaNacimientoNNA"></div>
            <div><label>Género</label>
              <select id="generoNNA"><option></option><option>Masculino</option><option>Femenino</option><option>Otro</option></select>
            </div>
          </div>
          <div class="form-row">
            <div><label>Centro de vida (localidad/prov.)</label><input id="centroVida"></div>
            <div><label>Vínculos fraternos preservados</label>
              <select id="vinculosFraternos"><option value=""></option><option>Sí</option><option>No</option></select>
            </div>
          </div>
          <div class="form-row full"><label>Situación</label><textarea id="situacionVulneracion"></textarea></div>
          <div class="small inline">
            <span id="edadNNAInfo" class="badge">Edad NNA: —</span>
          </div>
        </fieldset>

        <!-- Medida y Acogimiento (Ley II N° 36) -->
        <fieldset class="fieldset">
          <legend>Medida y Acogimiento (Ley II N° 36)</legend>
          <div class="form-row">
            <div><label>Tipo de medida excepcional</label>
              <select id="tipoMedida"><option value=""></option><option>Administrativa con intervención judicial</option><option>Judicial</option></select>
            </div>
            <div><label>Autoridad interviniente</label><input id="autoridadInterviniente" placeholder="Órgano/juzgado/área"></div>
          </div>
          <div class="form-row">
            <div><label>Fecha de la medida</label><input type="date" id="fechaMedida"></div>
            <div><label>Fecha de ingreso al SAF</label><input type="date" id="fechaIngresoSAF"></div>
          </div>
          <div class="form-row">
            <div><label>Tipo de familia de acogimiento</label>
              <select id="tipoFamilia"><option value=""></option><option>Alternativa</option><option>Inmediata (≤ 10 días)</option></select>
            </div>
            <div><label>RUFAAFA (N° registro)</label><input id="rufAAFA"></div>
          </div>

          <div class="form-row">
            <div><label>Referente de familia de acogimiento</label><input id="faNombre" placeholder="Nombre y apellido"></div>
            <div><label>DNI referente</label><input id="faDni" placeholder="Documento"></div>
          </div>
          <div class="form-row">
            <div><label>Fecha nac. referente</label><input type="date" id="faFechaNac"></div>
            <div><label>Contacto (tel/correo)</label><input id="faContacto"></div>
          </div>
          <div class="form-row">
            <div><label>Domicilio familia de acogimiento</label><input id="faDomicilio"></div>
            <div><label>Años de residencia en Misiones</label><input type="number" min="0" step="1" id="faResidenciaAnos" placeholder="Ej: 3"></div>
          </div>

          <div class="small inline">
            <span id="edadFAInfo" class="badge">Edad referente: —</span>
            <span id="difEdadInfo" class="badge">Diferencia con NNA: —</span>
            <span id="residenciaInfo" class="badge">Residencia: —</span>
          </div>

          <div class="form-row full">
            <label>Etapa del proceso (Art. 14)</label>
            <div class="chips">
              <label class="chip"><input type="checkbox" id="etapaConvocatoria"> Convocatoria</label>
              <label class="chip"><input type="checkbox" id="etapaEvaluacion"> Evaluación y selección</label>
              <label class="chip"><input type="checkbox" id="etapaCapacitacion"> Capacitación</label>
              <label class="chip"><input type="checkbox" id="etapaInscripcion"> Inscripción RUFAAFA</label>
              <label class="chip"><input type="checkbox" id="etapaPlan"> Plan de intervención</label>
            </div>
          </div>

          <div class="form-row full">
            <label>Plan de intervención</label>
            <textarea id="planIntervencion" placeholder="Objetivos, acciones, roles (Art.14.5)"></textarea>
          </div>

          <div class="form-row">
            <div><label>Egreso (si aplica)</label>
              <select id="causalEgreso">
                <option value=""></option>
                <option>Revinculación con familia de origen</option>
                <option>Vinculación con familia extensa</option>
                <option>Adoptabilidad y guarda con fines de adopción</option>
                <option>Mayoría de edad</option>
              </select>
            </div>
            <div><label>Fecha de egreso</label><input type="date" id="fechaEgreso"></div>
          </div>

          <div class="form-row full">
            <label>Observaciones sobre derecho a ser oído / identidad / integridad</label>
            <textarea id="obsDerechos" placeholder="Registro de escucha activa, identidad y resguardo (Art. 4)"></textarea>
          </div>
        </fieldset>

        <!-- Requisitos RUFAAFA (Art. 18) -->
        <fieldset class="fieldset">
          <legend>Requisitos RUFAAFA (Art. 18)</legend>
          <div class="subgrid-3">
            <label class="chip"><input type="checkbox" id="reqDomicilio"> Domicilio en Misiones (≥ 2 años)</label>
            <label class="chip"><input type="checkbox" id="reqEdad"> Mayor de 25 años</label>
            <label class="chip"><input type="checkbox" id="reqDiferenciaEdad"> Diferencia ≥ 15 años con el NNA</label>
            <label class="chip"><input type="checkbox" id="reqPenales"> Cert. antecedentes penales</label>
            <label class="chip"><input type="checkbox" id="reqAlimentaria"> Libre deuda alimentaria</label>
            <label class="chip"><input type="checkbox" id="reqPsicofisico"> Aptitud psicofísica (sector público)</label>
            <label class="chip"><input type="checkbox" id="reqIngresos"> Constancia/ DDJJ de ingresos</label>
            <label class="chip"><input type="checkbox" id="reqVivienda"> Acredita vivienda (propia/locación)</label>
            <label class="chip"><input type="checkbox" id="reqCapacitacion"> Capacitaciones realizadas</label>
            <label class="chip"><input type="checkbox" id="reqAcuerdo"> Acuerdo de aceptación firmado</label>
          </div>
        </fieldset>

        <!-- Inhabilidades (Art. 19) -->
        <fieldset class="fieldset">
          <legend>Inhabilidades (Art. 19)</legend>
          <div class="subgrid-3">
            <label class="chip"><input type="checkbox" id="inhDelitos"> Sin condena por delitos dolosos</label>
            <label class="chip"><input type="checkbox" id="inhMedidas"> Sin medidas cautelares vigentes (L. XIV-6 / IV-68)</label>
            <label class="chip"><input type="checkbox" id="inhRespParental"> Sin privación/suspensión de resp. parental</label>
            <label class="chip"><input type="checkbox" id="inhTutela"> Sin remoción de tutela por mal desempeño</label>
          </div>
        </fieldset>

        <div class="form-row">
          <div><label>Expediente de referencia</label>
            <select id="expedienteReferencia"><option value="">-- Seleccione --</option></select>
            <small id="expedienteInfo" class="small"></small>
          </div>
          <div><label>Estado</label>
            <select id="estadoCaso"><option>Abierto</option><option>En Proceso</option><option>Cerrado</option></select>
          </div>
        </div>

        <div class="form-row full"><label>Seguimiento inicial</label><textarea id="seguimientoInicial" placeholder="Anote el primer seguimiento o acción..."></textarea></div>

        <div class="form-row">
          <div><label>Lugar de institucionalización</label><textarea id="lugarInstitucionalizacion" placeholder="Si corresponde"></textarea></div>
          <div><label>Contacto institucionalización</label><textarea id="contactoInstitucionalizacion" placeholder="Si corresponde"></textarea></div>
        </div>

        <div class="form-row">
          <div class="inline">
            <button type="submit" class="btn btn-primary">Guardar</button>
            <button type="button" class="btn btn-secondary" onclick="imprimirSeccion('registro')">Imprimir</button>
          </div>
        </div>
      </form>
      <p id="validacionMsg" class="small"></p>
    </div>

    <!-- Casos -->
    <div id="casos" class="tab-content">
      <div style="display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap">
        <h2>Casos Registrados</h2>
        <div class="inline">
          <button class="btn btn-primary" onclick="imprimirSeccion('casos')">Imprimir listado</button>
        </div>
      </div>
      <div class="filters">
        <input id="searchInput" placeholder="Buscar nombre/DNI" oninput="aplicarFiltros()">
        <select id="estadoFilter" onchange="aplicarFiltros()">
          <option value="">Todos</option><option>Abierto</option><option>En Proceso</option><option>Cerrado</option>
        </select>
      </div>
      <div id="tablaCasos"></div>
    </div>
  </div>

  <!-- Sidebar Seguimiento -->
  <aside id="sidebarSeguimiento">
    <div class="s-header"><span id="sidebarTitle"></span>
      <div class="inline">
        <button class="btn btn-secondary" onclick="imprimirSeccion('sidebarSeguimiento')">Imprimir</button>
        <button class="btn btn-danger" onclick="cerrarSidebar()">✕</button>
      </div>
    </div>
    <div class="s-body"><div id="timeline"></div></div>
    <div class="seguimiento-form">
      <textarea id="nuevoSeguimiento" rows="3" placeholder="Agregar seguimiento..."></textarea>
      <button class="btn btn-primary" style="width:100%;margin-top:8px" onclick="guardarSeguimiento()">Agregar Seguimiento</button>
    </div>
  </aside>

  <!-- Modal Caso -->
  <div id="modalCaso" class="modal"><div class="modal-card">
    <div class="modal-head"><h3>Detalle del Caso</h3>
      <div class="inline">
        <button class="btn btn-secondary" onclick="imprimirSeccion('modalCasoBody')">Imprimir</button>
        <button class="btn btn-danger" onclick="cerrarModalCaso()">✕</button>
      </div></div>
    <div class="modal-body" id="modalCasoBody"></div>
    <div class="print-actions">
      <button class="btn btn-danger" onclick="eliminarCaso()">Eliminar Caso</button>
    </div>
  </div></div>

  <!-- Modal Expediente -->
  <div id="modalExpediente" class="modal"><div class="modal-card">
    <div class="modal-head"><h3>Detalle de Expediente</h3>
      <div class="inline">
        <button class="btn btn-secondary" onclick="imprimirSeccion('modalExpedienteBody')">Imprimir</button>
        <button class="btn btn-danger" onclick="cerrarModalExpediente()">✕</button>
      </div>
    </div>
    <div class="modal-body" id="modalExpedienteBody"></div>
  </div></div>

  <script type="module">
    // ===== Firebase (RTDB) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, push, get, child, set, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    function formatFechaHora(date){
      return new Intl.DateTimeFormat("es-AR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:false}).format(date);
    }
    function formatFecha(date){
      return new Intl.DateTimeFormat("es-AR",{day:"2-digit",month:"2-digit",year:"numeric"}).format(date);
    }
    const $ = (id)=>document.getElementById(id);

    // Firebase App 1: proteccion-personas (casos) — RTDB
   const app1 = initializeApp({apiKey:"AIzaSyAWlsFqN09y_DAAIKLLIjGjjyR2_rKJIFs",authDomain:"proteccion-personas.firebaseapp.com",projectId:"proteccion-personas"},"app1");
    const rtdb1 = getDatabase(app1);

    // Firebase App 2: causas-defensoria (causas) — RTDB
    const app2 = initializeApp({
      apiKey:"AIzaSyBt6X0u0BpiNPcV2SNPrN-spCmjl2AhZaA",
      authDomain:"causas-defensoria.firebaseapp.com",
      projectId:"causas-defensoria",
      storageBucket:"causas-defensoria.firebasestorage.app",
      messagingSenderId:"186064671470",
      appId:"1:186064671470:web:b58bae5eadbe6e469f19ff",
      databaseURL:"https://causas-defensoria.firebaseio.com"
    },"app2");
    const rtdb2 = getDatabase(app2);

    // ===== Estado =====
    let casos=[], casosFiltrados=[], casoActual=null, editandoId=null, lastEditedId=null;
    let causasIndex = {};

    // ===== Refs DOM =====
    const form=$('casoForm'), formTitle=$('formTitle');
    const nombreNNA=$('nombreNNA'), dniNNA=$('dniNNA'), fechaNacimientoNNA=$('fechaNacimientoNNA'), generoNNA=$('generoNNA'),
          centroVida=$('centroVida'), vinculosFraternos=$('vinculosFraternos'), situacionVulneracion=$('situacionVulneracion');
    const tipoMedida=$('tipoMedida'), autoridadInterviniente=$('autoridadInterviniente'), fechaMedida=$('fechaMedida'), fechaIngresoSAF=$('fechaIngresoSAF'), tipoFamilia=$('tipoFamilia'), rufAAFA=$('rufAAFA');
    const faNombre=$('faNombre'), faDni=$('faDni'), faFechaNac=$('faFechaNac'), faDomicilio=$('faDomicilio'), faContacto=$('faContacto'), faResidenciaAnos=$('faResidenciaAnos');
    const edadNNAInfo=$('edadNNAInfo'), edadFAInfo=$('edadFAInfo'), difEdadInfo=$('difEdadInfo'), residenciaInfo=$('residenciaInfo');
    const etapaConvocatoria=$('etapaConvocatoria'), etapaEvaluacion=$('etapaEvaluacion'), etapaCapacitacion=$('etapaCapacitacion'), etapaInscripcion=$('etapaInscripcion'), etapaPlan=$('etapaPlan'), planIntervencion=$('planIntervencion');
    const causalEgreso=$('causalEgreso'), fechaEgreso=$('fechaEgreso'), obsDerechos=$('obsDerechos');
    const reqDomicilio=$('reqDomicilio'), reqEdad=$('reqEdad'), reqDiferenciaEdad=$('reqDiferenciaEdad'), reqPenales=$('reqPenales'), reqAlimentaria=$('reqAlimentaria'), reqPsicofisico=$('reqPsicofisico'), reqIngresos=$('reqIngresos'), reqVivienda=$('reqVivienda'), reqCapacitacion=$('reqCapacitacion'), reqAcuerdo=$('reqAcuerdo');
    const inhDelitos=$('inhDelitos'), inhMedidas=$('inhMedidas'), inhRespParental=$('inhRespParental'), inhTutela=$('inhTutela');
    const seguimientoInicial=$('seguimientoInicial'), estadoCaso=$('estadoCaso'), lugarInstitucionalizacion=$('lugarInstitucionalizacion'), contactoInstitucionalizacion=$('contactoInstitucionalizacion');
    const expedienteSelect=$('expedienteReferencia'), expedienteInfo=$('expedienteInfo');
    const searchInput=$('searchInput'), estadoFilter=$('estadoFilter'), tablaCasos=$('tablaCasos');
    const totalCasos=$('totalCasos'), casosAbiertos=$('casosAbiertos'), casosProceso=$('casosProceso'), casosCerrados=$('casosCerrados'), listaTramite=$('listaTramite');
    const sidebarSeguimiento=$('sidebarSeguimiento'), sidebarTitle=$('sidebarTitle'), timeline=$('timeline'), nuevoSeguimiento=$('nuevoSeguimiento');
    const modalCaso=$('modalCaso'), modalCasoBody=$('modalCasoBody');
    const validacionMsg=$('validacionMsg');

    // ===== Utilidades =====
    function calcEdad(dateStr){
      if(!dateStr) return null;
      const d=new Date(dateStr), t=new Date();
      let e=t.getFullYear()-d.getFullYear();
      const m=t.getMonth()-d.getMonth();
      if(m<0 || (m===0 && t.getDate()<d.getDate())) e--;
      return e>=0?e:null;
    }
    function setBadge(el, text, level=""){
      el.textContent = text;
      el.classList.remove("badge-ok","badge-warn","badge-danger");
      if(level) el.classList.add(level);
    }
    function actualizarAutoChecks(){
      const edadNNA = calcEdad(fechaNacimientoNNA.value);
      const edadFA  = calcEdad(faFechaNac.value);
      if(edadNNA!=null) setBadge(edadNNAInfo, `Edad NNA: ${edadNNA} años`, "badge-ok"); else setBadge(edadNNAInfo, "Edad NNA: —");
      if(edadFA!=null)  setBadge(edadFAInfo, `Edad referente: ${edadFA} años`, edadFA>=25?"badge-ok":"badge-danger"); else setBadge(edadFAInfo, "Edad referente: —");

      if(edadFA!=null){ reqEdad.checked = edadFA>=25; }
      if(edadFA!=null && edadNNA!=null){
        const diff = edadFA - edadNNA;
        const ok = diff>=15;
        reqDiferenciaEdad.checked = ok;
        setBadge(difEdadInfo, `Diferencia con NNA: ${diff} años`, ok?"badge-ok":"badge-danger");
      }else{
        setBadge(difEdadInfo, "Diferencia con NNA: —");
      }
      const anos = parseInt(faResidenciaAnos.value,10);
      if(!isNaN(anos)){
        reqDomicilio.checked = anos>=2;
        setBadge(residenciaInfo, `Residencia: ${anos} años`, anos>=2?"badge-ok":"badge-warn");
      }else{
        setBadge(residenciaInfo, "Residencia: —");
      }
      const faltas = [];
      if(edadFA!=null && edadFA<25) faltas.push("El referente debe ser ≥ 25 años.");
      if(edadFA!=null && edadNNA!=null && (edadFA-edadNNA)<15) faltas.push("La diferencia de edad con el NNA debe ser ≥ 15 años.");
      if(!isNaN(anos) && anos<2) faltas.push("Residencia en Misiones debe ser ≥ 2 años.");
      validacionMsg.textContent = faltas.length? "⚠️ " + faltas.join(" ") : "";
    }

    // ===== Eventos =====
    document.addEventListener("DOMContentLoaded", async ()=>{
      await Promise.all([cargarExpedientes(), cargarCasos()]);
      [fechaNacimientoNNA, faFechaNac, faResidenciaAnos].forEach(el=> el.addEventListener('input', actualizarAutoChecks));
    });
    form.addEventListener("submit", guardarCaso);
    expedienteSelect.addEventListener("change", ()=>{
      const id = expedienteSelect.value;
      if(!id){expedienteInfo.textContent=""; return;}
      const c = causasIndex[id];
      expedienteInfo.textContent = c ? `Seleccionado: ${c.numero || id} — ${c.caratula || ''}` : "";
    });

    // ===== Cargar expedientes (RTDB app2:/causas) =====
    async function cargarExpedientes(){
      expedienteSelect.innerHTML = "<option value=''>-- Seleccione --</option>";
      causasIndex = {};
      const snap = await get(child(ref(rtdb2), "causas"));
      if(snap.exists()){
        const data = snap.val();
        Object.entries(data).forEach(([id,val])=>{
          causasIndex[id] = val || {};
          const opt = document.createElement("option");
          opt.value = id;
          const numero = val?.numero ? ("Causa " + val.numero) : "Expediente";
          opt.textContent = numero + (val?.caratula ? (" – " + val.caratula) : "");
          expedienteSelect.appendChild(opt);
        });
      }
    }

    // ===== Guardar / Actualizar caso (RTDB app1:/casos) =====
    async function guardarCaso(e){
      e.preventDefault();
      const edadN = calcEdad(fechaNacimientoNNA.value);
      const edadF = calcEdad(faFechaNac.value);
      const anosRes = parseInt(faResidenciaAnos.value,10);
      if(edadF!=null && edadF<25){ alert("No se puede guardar: el referente debe tener 25 años o más (Art. 18)."); return; }
      if(edadN!=null && edadF!=null && (edadF-edadN)<15){ alert("No se puede guardar: la diferencia entre el referente y el NNA debe ser de 15 años o más (Art. 18)."); return; }
      if(!isNaN(anosRes) && anosRes<2){ alert("No se puede guardar: la residencia en Misiones debe ser de 2 años o más (Art. 18)."); return; }

      const etapas = {
        convocatoria: !!etapaConvocatoria.checked,
        evaluacion: !!etapaEvaluacion.checked,
        capacitacion: !!etapaCapacitacion.checked,
        inscripcion: !!etapaInscripcion.checked,
        plan: !!etapaPlan.checked
      };
      const requisitos = {
        reqDomicilio: !!reqDomicilio.checked,
        reqEdad: !!reqEdad.checked,
        reqDiferenciaEdad: !!reqDiferenciaEdad.checked,
        reqPenales: !!reqPenales.checked,
        reqAlimentaria: !!reqAlimentaria.checked,
        reqPsicofisico: !!reqPsicofisico.checked,
        reqIngresos: !!reqIngresos.checked,
        reqVivienda: !!reqVivienda.checked,
        reqCapacitacion: !!reqCapacitacion.checked,
        reqAcuerdo: !!reqAcuerdo.checked
      };
      const inhabilidades = {
        inhDelitos: !!inhDelitos.checked,
        inhMedidas: !!inhMedidas.checked,
        inhRespParental: !!inhRespParental.checked,
        inhTutela: !!inhTutela.checked
      };

      const data = {
        nombreNNA: nombreNNA.value,
        dniNNA: dniNNA.value,
        fechaNacimientoNNA: fechaNacimientoNNA.value,
        generoNNA: generoNNA.value,
        centroVida: centroVida.value,
        vinculosFraternos: vinculosFraternos.value,
        situacionVulneracion: situacionVulneracion.value,
        tipoMedida: tipoMedida.value,
        autoridadInterviniente: autoridadInterviniente.value,
        fechaMedida: fechaMedida.value,
        fechaIngresoSAF: fechaIngresoSAF.value,
        tipoFamilia: tipoFamilia.value,
        rufAAFA: rufAAFA.value,
        faNombre: faNombre.value,
        faDni: faDni.value,
        faFechaNac: faFechaNac.value,
        faDomicilio: faDomicilio.value,
        faContacto: faContacto.value,
        faResidenciaAnos: faResidenciaAnos.value,
        etapas, planIntervencion: planIntervencion.value,
        causalEgreso: causalEgreso.value, fechaEgreso: fechaEgreso.value,
        obsDerechos: obsDerechos.value,
        requisitos, inhabilidades,
        estadoCaso: estadoCaso.value,
        expedienteReferencia: expedienteSelect.value || "",
        lugarInstitucionalizacion: lugarInstitucionalizacion.value,
        contactoInstitucionalizacion: contactoInstitucionalizacion.value
      };

      if(editandoId){
        const targetRef = ref(rtdb1, "casos/" + editandoId);
        const snap = await get(targetRef);
        let historial = (snap.exists() && snap.val().historial) ? snap.val().historial : [];
        historial.push({fecha:formatFechaHora(new Date()), accion:"Edición del caso"});
        await update(targetRef, {...data, historial});
        lastEditedId = editandoId;
        editandoId = null;
        formTitle.textContent = "Nuevo Caso";
      }else{
        const nuevo = {
          ...data,
          fechaRegistro: formatFecha(new Date()),
          seguimientos: seguimientoInicial.value ? [{fecha:formatFechaHora(new Date()), texto: seguimientoInicial.value}] : [],
          historial: [{fecha:formatFechaHora(new Date()), accion:"Creación del caso"}]
        };
        const res = await push(ref(rtdb1,"casos"), nuevo);
        lastEditedId = res.key;
      }
      form.reset();
      expedienteInfo.textContent = "";
      actualizarAutoChecks();
      await cargarCasos();
      showTab('casos');
    }

    // ===== Cargar casos (RTDB app1:/casos) =====
    async function cargarCasos(){
      casos = [];
      const s = await get(child(ref(rtdb1),"casos"));
      if(s.exists()){
        const data = s.val() || {};
        casos = Object.entries(data).map(([id, val])=>({id, ...(val||{})}));
      }
      aplicarFiltros();
      actualizarDashboard();
      renderTramite();
    }

    function aplicarFiltros(){
      const q = (searchInput?.value||"").toLowerCase();
      const est = (estadoFilter?.value||"");
      casosFiltrados = casos
        .filter(c => (c.nombreNNA||"").toLowerCase().includes(q) || (c.dniNNA||"").includes(q))
        .filter(c => !est || c.estadoCaso===est);
      mostrarCasos();
    }

    function getExpDisplay(id){
      if(!id) return "";
      const c = causasIndex[id];
      return c ? (c.caratula || c.numero || "") : "";
    }

    function mostrarCasos(){
      if(!casosFiltrados.length){ tablaCasos.innerHTML="<p>Sin casos</p>"; return; }
      let h = "<table class='cases-table'><tr><th></th><th>Nombre</th><th>Estado</th><th>SAF</th><th>Expediente</th><th>Acciones</th></tr>";
      for(const c of casosFiltrados){
        const cls = c.estadoCaso==="Abierto" ? "status-abierto" : (c.estadoCaso==="Cerrado" ? "status-cerrado" : "status-en");
        const expTxt = c.expedienteReferencia ? getExpDisplay(c.expedienteReferencia) : "";
        const expHtml = c.expedienteReferencia ? `<a class="link" href="#" onclick="verExpediente('${c.expedienteReferencia}')">${expTxt}</a>` : "";
        const safBadge = c.tipoFamilia ? `<span class="chip">${c.tipoFamilia}</span>` : "";
        h += `<tr id="row-${c.id}">
                <td><input type="checkbox" onchange="toggleSidebar('${c.id}',this.checked)"></td>
                <td>${c.nombreNNA||""}</td>
                <td class="${cls}">${c.estadoCaso||""}</td>
                <td>${safBadge}</td>
                <td>${expHtml}</td>
                <td class="actions">
                  <button class="btn btn-ghost" onclick="editarCaso('${c.id}')">Editar</button>
                  <button class="btn btn-ghost" onclick="verCaso('${c.id}')">Vista</button>
                  <button class="btn btn-danger" onclick="eliminarCaso('${c.id}')">Eliminar</button>
                </td>
              </tr>`;
      }
      h += "</table>";
      tablaCasos.innerHTML = h;

      if(lastEditedId){
        const row = $('row-'+lastEditedId);
        if(row){ row.classList.add('row-highlight'); row.scrollIntoView({behavior:'smooth', block:'center'}); }
        lastEditedId = null;
      }
    }

    function actualizarDashboard(){
      totalCasos.textContent = casos.length;
      casosAbiertos.textContent = casos.filter(c=>c.estadoCaso==="Abierto").length;
      casosProceso.textContent = casos.filter(c=>c.estadoCaso==="En Proceso").length;
      casosCerrados.textContent = casos.filter(c=>c.estadoCaso==="Cerrado").length;
    }

    function renderTramite(){
      listaTramite.innerHTML="";
      casos.filter(c=>c.estadoCaso==="En Proceso").forEach(c=>{
        const li=document.createElement("li");
        const expTxt = c.expedienteReferencia ? getExpDisplay(c.expedienteReferencia) : "-";
        li.innerHTML = `<b>${c.nombreNNA||"Sin nombre"}</b> · Exp: ${expTxt} ` + (c.tipoFamilia? `· <i>${c.tipoFamilia}</i>`:"");
        listaTramite.appendChild(li);
      });
    }

    // ===== Editar (carga en formulario) =====
    window.editarCaso = (id)=>{
      const c = casos.find(x=>x.id===id); if(!c) return;
      editandoId = id; formTitle.textContent = "Editar Caso";
      nombreNNA.value = c.nombreNNA || ""; dniNNA.value = c.dniNNA || "";
      fechaNacimientoNNA.value = c.fechaNacimientoNNA || ""; generoNNA.value = c.generoNNA || "";
      centroVida.value = c.centroVida || ""; vinculosFraternos.value = c.vinculosFraternos || "";
      situacionVulneracion.value = c.situacionVulneracion || "";
      tipoMedida.value = c.tipoMedida || ""; autoridadInterviniente.value = c.autoridadInterviniente || "";
      fechaMedida.value = c.fechaMedida || ""; fechaIngresoSAF.value = c.fechaIngresoSAF || "";
      tipoFamilia.value = c.tipoFamilia || ""; rufAAFA.value = c.rufAAFA || "";
      faNombre.value = c.faNombre || ""; faDni.value = c.faDni || ""; faFechaNac.value = c.faFechaNac || "";
      faDomicilio.value = c.faDomicilio || ""; faContacto.value = c.faContacto || "";
      faResidenciaAnos.value = c.faResidenciaAnos || "";
      etapaConvocatoria.checked = !!(c.etapas?.convocatoria);
      etapaEvaluacion.checked = !!(c.etapas?.evaluacion);
      etapaCapacitacion.checked = !!(c.etapas?.capacitacion);
      etapaInscripcion.checked = !!(c.etapas?.inscripcion);
      etapaPlan.checked = !!(c.etapas?.plan);
      planIntervencion.value = c.planIntervencion || "";
      causalEgreso.value = c.causalEgreso || ""; fechaEgreso.value = c.fechaEgreso || "";
      obsDerechos.value = c.obsDerechos || "";
      reqDomicilio.checked = !!(c.requisitos?.reqDomicilio);
      reqEdad.checked = !!(c.requisitos?.reqEdad);
      reqDiferenciaEdad.checked = !!(c.requisitos?.reqDiferenciaEdad);
      reqPenales.checked = !!(c.requisitos?.reqPenales);
      reqAlimentaria.checked = !!(c.requisitos?.reqAlimentaria);
      reqPsicofisico.checked = !!(c.requisitos?.reqPsicofisico);
      reqIngresos.checked = !!(c.requisitos?.reqIngresos);
      reqVivienda.checked = !!(c.requisitos?.reqVivienda);
      reqCapacitacion.checked = !!(c.requisitos?.reqCapacitacion);
      reqAcuerdo.checked = !!(c.requisitos?.reqAcuerdo);
      inhDelitos.checked = !!(c.inhabilidades?.inhDelitos);
      inhMedidas.checked = !!(c.inhabilidades?.inhMedidas);
      inhRespParental.checked = !!(c.inhabilidades?.inhRespParental);
      inhTutela.checked = !!(c.inhabilidades?.inhTutela);
      estadoCaso.value = c.estadoCaso || "Abierto";
      expedienteSelect.value = c.expedienteReferencia || "";
      expedienteInfo.textContent = c.expedienteReferencia ? `Seleccionado: ${getExpDisplay(c.expedienteReferencia)}` : "";
      lugarInstitucionalizacion.value = c.lugarInstitucionalizacion || "";
      contactoInstitucionalizacion.value = c.contactoInstitucionalizacion || "";
      actualizarAutoChecks();
      showTab('registro');
    };

    // ===== Sidebar Seguimiento =====
    window.toggleSidebar = async (id, ch)=>{
      if(ch){
        const s = await get(child(ref(rtdb1),"casos/"+id));
        if(s.exists()){
          casoActual = {id, ...(s.val()||{})};
          sidebarTitle.textContent = "Seguimiento · " + (casoActual.nombreNNA||"");
          renderTimeline();
          sidebarSeguimiento.classList.add("active");
        }
      }else cerrarSidebar();
    };

    function renderTimeline(){
      const arr = Array.isArray(casoActual?.seguimientos) ? casoActual.seguimientos : [];
      timeline.innerHTML = arr.length
        ? arr.map((s,i)=>`<div class='timeline-item'><div class='date'>${s.fecha}</div><div>${s.texto}</div><button class='delete-btn' title='Eliminar' onclick='eliminarSeguimiento(${i})'>✕</button></div>`).join("")
        : "<p>Sin seguimientos</p>";
    }

    window.guardarSeguimiento = async ()=>{
      if(!casoActual || !nuevoSeguimiento.value) return;
      const arr = Array.isArray(casoActual.seguimientos) ? casoActual.seguimientos : [];
      arr.push({fecha:formatFechaHora(new Date()), texto:nuevoSeguimiento.value});
      await update(ref(rtdb1,"casos/"+casoActual.id), {seguimientos:arr});
      casoActual.seguimientos = arr;
      nuevoSeguimiento.value = "";
      renderTimeline();
    };

    window.eliminarSeguimiento = async (i)=>{
      if(!casoActual) return;
      const arr = Array.isArray(casoActual.seguimientos) ? casoActual.seguimientos : [];
      arr.splice(i,1);
      await update(ref(rtdb1,"casos/"+casoActual.id), {seguimientos:arr});
      casoActual.seguimientos = arr;
      renderTimeline();
    };

    window.cerrarSidebar = ()=>{
      sidebarSeguimiento.classList.remove("active");
      document.querySelectorAll("#tablaCasos input[type=checkbox]").forEach(c=>c.checked=false);
    };

    // ===== Vista (modal) del Caso =====
    window.verCaso = async (id)=>{
      const s = await get(child(ref(rtdb1),"casos/"+id));
      if(!s.exists()) return;
      casoActual = {id, ...(s.val()||{})};

      const historialHTML = (casoActual.historial||[]).map(h=>`<p><span class='status-en'>${h.fecha}</span>: ${h.accion}</p>`).join("") || "<p>Sin historial</p>";
      const seguimientosHTML = (casoActual.seguimientos||[]).map(sg=>`<p><span class='status-en'>${sg.fecha}</span>: ${sg.texto}</p>`).join("") || "<p>Sin seguimiento</p>";
      const expHtml = casoActual.expedienteReferencia ? `<a class="link" href="#" onclick="verExpediente('${casoActual.expedienteReferencia}')">${getExpDisplay(casoActual.expedienteReferencia)}</a>` : "-";

      const reqList = casoActual.requisitos ? Object.entries(casoActual.requisitos).filter(([k,v])=>v).map(([k])=>k.replace('req','').replace(/[A-Z]/g,' $&')).join(', ') : '-';
      const inhList = casoActual.inhabilidades ? Object.entries(casoActual.inhabilidades).filter(([k,v])=>v).map(([k])=>k.replace('inh','').replace(/[A-Z]/g,' $&')).join(', ') : '-';

      const edadN = calcEdad(casoActual.fechaNacimientoNNA);
      const edadF = calcEdad(casoActual.faFechaNac);
      const diff = (edadN!=null && edadF!=null) ? (edadF-edadN) : null;

      modalCasoBody.innerHTML = `
        <div class='section'>
          <h4>Datos del NNA</h4>
          <div class="form-row">
            <div><b>Nombre:</b> ${casoActual.nombreNNA||""}</div>
            <div><b>DNI:</b> ${casoActual.dniNNA||""}</div>
          </div>
          <div class="form-row">
            <div><b>Fecha Nac.:</b> ${casoActual.fechaNacimientoNNA||""} ${edadN!=null?`<span class='badge badge-ok'>${edadN} años</span>`:""}</div>
            <div><b>Género:</b> ${casoActual.generoNNA||""}</div>
          </div>
          <div class="form-row">
            <div><b>Centro de vida:</b> ${casoActual.centroVida||""}</div>
            <div><b>Vínculos fraternos:</b> ${casoActual.vinculosFraternos||""}</div>
          </div>
          <div class="form-row">
            <div><b>Estado:</b> ${casoActual.estadoCaso||""}</div>
            <div><b>Exp. ref.:</b> ${expHtml}</div>
          </div>
          <div class="form-row">
            <div><b>Lugar de institucionalización:</b> ${casoActual.lugarInstitucionalizacion||""}</div>
            <div><b>Contacto institucionalización:</b> ${casoActual.contactoInstitucionalizacion||""}</div>
          </div>
        </div>

        <div class='section'>
          <h4>Medida y SAF</h4>
          <div class="form-row">
            <div><b>Tipo de medida:</b> ${casoActual.tipoMedida||""}</div>
            <div><b>Autoridad:</b> ${casoActual.autoridadInterviniente||""}</div>
          </div>
          <div class="form-row">
            <div><b>Fecha medida:</b> ${casoActual.fechaMedida||""}</div>
            <div><b>Ingreso SAF:</b> ${casoActual.fechaIngresoSAF||""}</div>
          </div>
          <div class="form-row">
            <div><b>Tipo familia:</b> ${casoActual.tipoFamilia||""}</div>
            <div><b>RUFAAFA:</b> ${casoActual.rufAAFA||""}</div>
          </div>
          <div class="form-row">
            <div><b>Referente:</b> ${casoActual.faNombre||""}</div>
            <div><b>DNI Referente:</b> ${casoActual.faDni||""}</div>
          </div>
          <div class="form-row">
            <div><b>Fecha nac. referente:</b> ${casoActual.faFechaNac||""} ${edadF!=null?`<span class='badge ${edadF>=25?'badge-ok':'badge-danger'}'>${edadF} años</span>`:""}</div>
            <div><b>Contacto FA:</b> ${casoActual.faContacto||""}</div>
          </div>
          <div class="form-row">
            <div><b>Domicilio FA:</b> ${casoActual.faDomicilio||""}</div>
            <div><b>Residencia en Misiones:</b> ${casoActual.faResidenciaAnos||"-"} ${casoActual.faResidenciaAnos?`<span class='badge ${(parseInt(casoActual.faResidenciaAnos,10)>=2)?'badge-ok':'badge-warn'}'>${casoActual.faResidenciaAnos} años</span>`:""}</div>
          </div>
          <div><b>Etapas:</b> ${Object.entries(casoActual.etapas||{}).filter(([k,v])=>v).map(([k])=>k).join(', ')||'-'}</div>
          <div style="margin-top:6px"><b>Plan de intervención:</b><br>${(casoActual.planIntervencion||"").replace(/\n/g,"<br>")}</div>
          ${diff!=null?`<div style="margin-top:6px"><b>Diferencia de edad referente/NNA:</b> ${diff} años ${diff>=15?'<span class="badge badge-ok">OK</span>':'<span class="badge badge-danger">Insuficiente</span>'}</div>`:""}
        </div>

        <div class='section'>
          <h4>RUFAAFA</h4>
          <p><b>Requisitos cumplidos:</b> ${reqList}</p>
          <p><b>Inhabilidades (negativas):</b> ${inhList}</p>
        </div>

        <div class='section'>
          <h4>Situación</h4>
          <p>${(casoActual.situacionVulneracion||"").replace(/\n/g,"<br>")}</p>
          <h4 style="margin-top:8px">Observaciones de derechos</h4>
          <p>${(casoActual.obsDerechos||"").replace(/\n/g,"<br>")}</p>
        </div>

        <div class='section'>
          <h4>Seguimientos</h4>
          ${seguimientosHTML}
        </div>
        <div class='section'>
          <h4>Egreso</h4>
          <div class="form-row">
            <div><b>Causal:</b> ${casoActual.causalEgreso||"-"}</div>
            <div><b>Fecha:</b> ${casoActual.fechaEgreso||"-"}</div>
          </div>
        </div>

        <div class='section'>
          <h4>Historial de cambios</h4>
          ${historialHTML}
        </div>`;
      modalCaso.classList.add("open");
    };

    window.cerrarModalCaso = ()=> modalCaso.classList.remove("open");

    window.eliminarCaso = async (id)=>{
      const targetId = id || (casoActual && casoActual.id);
      if(!targetId) return;
      if(confirm("¿Eliminar caso?")){
        await remove(ref(rtdb1,"casos/"+targetId));
        modalCaso.classList.remove("open");
        await cargarCasos();
      }
    };

    // ===== Modal Expediente (RTDB app2:/causas/{id}) =====
    window.verExpediente = async (id)=>{
      const d=await get(child(ref(rtdb2),"causas/"+id));
      if(!d.exists()) return;
      const data=d.val()||{};
      const segs = (data.seguimientos||[])
        .map(s=>`<p><span style="color:#004085;font-weight:bold">${s.fecha}:</span> ${s.texto}</p>`)
        .join("") || "<p style='color:gray'>Sin seguimientos registrados</p>";

      $('modalExpedienteBody').innerHTML = `
        <div class='section'>
          <h4>Datos del Expediente</h4>
          <p><b>Número de Causa:</b> ${data.numero||""}</p>
          <p><b>Carátula:</b> ${data.caratula||""}</p>
          <p><b>Fecha de Registro:</b> ${data.fecha||""}</p>
          <p><b>Estado:</b> ${data.estado||""}</p>
          <p><b>Detalle del Registro:</b><br>${(data.detalle||"").replace(/\n/g,"<br>")}</p>
        </div>
        <div class='section'>
          <h4>Seguimientos</h4>
          ${segs}
        </div>`;
      $('modalExpediente').classList.add("open");
    };

    window.cerrarModalExpediente = ()=>$('modalExpediente').classList.remove("open");

    // ===== Utilidades de impresión/exportación =====
    window.imprimirSeccion = (id)=>{
      const el = document.getElementById(id);
      if(!el) return;
      const w = window.open("", "_blank");
      const styles = document.querySelector('style')?.outerHTML || "";
      w.document.write(`<html><head><title>Imprimir</title>${styles}</head><body>${el.innerHTML}</body></html>`);
      w.document.close();
      w.focus();
      w.print();
    };
    window.exportarJSON = ()=>{
      const blob = new Blob([JSON.stringify(casos,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'casos.json';
      a.click();
      URL.revokeObjectURL(url);
    };

    // ===== Tabs =====
    window.showTab = (id, e)=>{
      document.querySelectorAll(".tab-content").forEach(x=>x.classList.remove("active"));
      const tab = document.getElementById(id);
      if(tab) tab.classList.add("active");
      // No marcamos 'active' en tarjetas para mantener estilo uniforme
    };
  </script>
</body>
</html>
